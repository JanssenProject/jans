<!doctype html>
<html lang="en-US">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Cedarling WASM App</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap.min.css"
        integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous">

    <style>
        textarea {
            width: 100%;
        }
    </style>
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
    <![endif]-->
</head>

<body>

    <div class="container">
        <!-- div to make init cedarling -->
        <div>
            <div class="row">
                <h2>Init cedarling</h2>
                input bootstrap config json
            </div>

            <!-- textarea with bootstrap config -->
            <div class="row">
                <!-- by default textarea contains example of bootstrap config, set by js -->
                <textarea id="bootstrap_config_textarea" rows="10" cols="100"></textarea>
            </div>

            <!-- Button to init cedarling with defined above bootsrap config JSON -->
            <div class="row">
                <button type="button" class="btn btn-default" id="bootstrap_init_button">Init Cedarling</button>
                <div style="display: none;" id="bootstrap_init_processing"> Processing...</div>
            </div>

            <!-- Success message -->
            <div class="row alert alert-success" role="alert" style="display: none" id="bootstrap_init_success">
                Cedarling initialized
            </div>

            <!-- Log panel, is showh only if "CEDARLING_LOG_TYPE": "memory" -->
            <div class="row panel panel-success" style="display: none;" id="bootstrap_init_log_panel">
                <h3>Logs</h3>
                <pre id="bootstrap_init_log_values">

            </pre>
            </div>

            <!-- Error message in case if cedarling initialized with error -->
            <div class="row alert alert-danger" role="alert" style="display: none" id="bootstrap_init_error">
                <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                <span class="sr-only">Error:</span>
                Error message
            </div>
        </div>

        <!-- div to make authorize request -->
        <div id="authorize_request_div" style="display: none;">
            <div class="row">
                <h3>Execute authorize request</h3>
                input json request
            </div>
            <!-- textarea with json request -->
            <div class="row">
                <textarea id="request_textarea" rows="10" cols="100"></textarea>
            </div>

            <!-- Button to execute authorize request -->
            <div class="row">
                <button type="button" class="btn btn-default" id="request_button">Execute request</button>
                <div style="display: none;" id="request_processing"> Processing...</div>
            </div>

            <!-- Error message in case if cedarling initialized with error -->
            <div class="row alert alert-danger" role="alert" style="display: none" id="request_error">
                <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                <span class="sr-only">Error:</span>
                Error message
            </div>

            <!-- Result panel -->
            <div class="row panel panel-success" style="display: none;" id="request_result_panel">
                <h3>Result</h3>
                <pre id="request_result_values"></pre>
            </div>


            <!-- Log panel, is showh only if "CEDARLING_LOG_TYPE": "memory" -->
            <div class="row panel panel-success" style="display: none;" id="request_log_panel">
                <h3>Logs</h3>
                <pre id="request_log_values"></pre>
            </div>


        </div>


    </div>





    <script type="module">
        import initWasm, { init, Cedarling } from "./pkg/cedarling_wasm.js";
        async function main() {
            await initWasm(); // Initialize the WebAssembly module
            window.Cedarling = Cedarling;
            window.cedarling_init = init;
        }
        main().catch(console.error);

    </script>


    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://code.jquery.com/jquery-1.12.4.min.js"
        integrity="sha384-nvAa0+6Qg9clwYCGGPpDQLVpLNn0fRaROjHqs13t4Ggj3Ez50XnGQqc/r8MhnRDZ"
        crossorigin="anonymous"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/js/bootstrap.min.js"
        integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd"
        crossorigin="anonymous"></script>

    <script>
        // At first we define default config and request

        const RAW_DEFAULT_BOOTSTRAP_CONFIG = JSON.stringify({
            "CEDARLING_APPLICATION_NAME": "My App",
            "CEDARLING_POLICY_STORE_URI": "https://raw.githubusercontent.com/JanssenProject/jans/refs/heads/main/jans-cedarling/bindings/cedarling_python/example_files/policy-store.json",
            "CEDARLING_LOG_TYPE": "memory",
            "CEDARLING_LOG_LEVEL": "DEBUG",
            "CEDARLING_LOG_TTL": 120,
            "CEDARLING_DECISION_LOG_USER_CLAIMS ": ["aud", "sub", "email", "username"],
            "CEDARLING_DECISION_LOG_WORKLOAD_CLAIMS ": ["aud", "client_id", "rp_id"],
            "CEDARLING_USER_AUTHZ": "enabled",
            "CEDARLING_WORKLOAD_AUTHZ": "enabled",
            "CEDARLING_USER_WORKLOAD_BOOLEAN_OPERATION": "AND",
            "CEDARLING_LOCAL_JWKS": null,
            "CEDARLING_LOCAL_POLICY_STORE": null,
            "CEDARLING_POLICY_STORE_LOCAL_FN": null,
            "CEDARLING_JWT_SIG_VALIDATION": "disabled",
            "CEDARLING_JWT_STATUS_VALIDATION": "disabled",
            "CEDARLING_JWT_SIGNATURE_ALGORITHMS_SUPPORTED": [
                "HS256",
                "RS256"
            ],
            "CEDARLING_AT_ISS_VALIDATION": "disabled",
            "CEDARLING_AT_JTI_VALIDATION": "disabled",
            "CEDARLING_AT_NBF_VALIDATION": "disabled",
            "CEDARLING_AT_EXP_VALIDATION": "disabled",
            "CEDARLING_IDT_ISS_VALIDATION": "disabled",
            "CEDARLING_IDT_SUB_VALIDATION": "disabled",
            "CEDARLING_IDT_EXP_VALIDATION": "disabled",
            "CEDARLING_IDT_IAT_VALIDATION": "disabled",
            "CEDARLING_IDT_AUD_VALIDATION": "disabled",
            "CEDARLING_USERINFO_ISS_VALIDATION": "disabled",
            "CEDARLING_USERINFO_SUB_VALIDATION": "disabled",
            "CEDARLING_USERINFO_AUD_VALIDATION": "disabled",
            "CEDARLING_USERINFO_EXP_VALIDATION": "disabled",
            "CEDARLING_ID_TOKEN_TRUST_MODE": "strict",
            "CEDARLING_LOCK": "disabled",
            "CEDARLING_LOCK_MASTER_CONFIGURATION_URI": null,
            "CEDARLING_DYNAMIC_CONFIGURATION": "disabled",
            "CEDARLING_LOCK_SSA_JWT": "",
            "CEDARLING_AUDIT_HEALTH_INTERVAL": 0,
            "CEDARLING_AUDIT_TELEMETRY_INTERVAL": 0,
            "CEDARLING_LISTEN_SSE": "disabled"
        }, null, 2);


        // Payload of access_token:
        // {
        //   "sub": "qzxn1Scrb9lWtGxVedMCky-Ql_ILspZaQA6fyuYktw0",
        //   "code": "3e2a2012-099c-464f-890b-448160c2ab25",
        //   "iss": "https://account.gluu.org",
        //   "token_type": "Bearer",
        //   "client_id": "d7f71bea-c38d-4caf-a1ba-e43c74a11a62",
        //   "aud": "d7f71bea-c38d-4caf-a1ba-e43c74a11a62",
        //   "acr": "simple_password_auth",
        //   "x5t#S256": "",
        //   "nbf": 1731953030,
        //   "scope": [
        //     "role",
        //     "openid",
        //     "profile",
        //     "email"
        //   ],
        //   "auth_time": 1731953027,
        //   "exp": 1732121460,
        //   "iat": 1731953030,
        //   "jti": "uZUh1hDUQo6PFkBPnwpGzg",
        //   "username": "Default Admin User",
        //   "status": {
        //     "status_list": {
        //       "idx": 306,
        //       "uri": "https://jans.test/jans-auth/restv1/status_list"
        //     }
        //   }
        // }
        let ACCESS_TOKEN = "eyJraWQiOiJjb25uZWN0X2Y5YTAwN2EyLTZkMGItNDkyYS05MGNkLWYwYzliMWMyYjVkYl9zaWdfcnMyNTYiLCJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJzdWIiOiJxenhuMVNjcmI5bFd0R3hWZWRNQ2t5LVFsX0lMc3BaYVFBNmZ5dVlrdHcwIiwiY29kZSI6IjNlMmEyMDEyLTA5OWMtNDY0Zi04OTBiLTQ0ODE2MGMyYWIyNSIsImlzcyI6Imh0dHBzOi8vYWNjb3VudC5nbHV1Lm9yZyIsInRva2VuX3R5cGUiOiJCZWFyZXIiLCJjbGllbnRfaWQiOiJkN2Y3MWJlYS1jMzhkLTRjYWYtYTFiYS1lNDNjNzRhMTFhNjIiLCJhdWQiOiJkN2Y3MWJlYS1jMzhkLTRjYWYtYTFiYS1lNDNjNzRhMTFhNjIiLCJhY3IiOiJzaW1wbGVfcGFzc3dvcmRfYXV0aCIsIng1dCNTMjU2IjoiIiwibmJmIjoxNzMxOTUzMDMwLCJzY29wZSI6WyJyb2xlIiwib3BlbmlkIiwicHJvZmlsZSIsImVtYWlsIl0sImF1dGhfdGltZSI6MTczMTk1MzAyNywiZXhwIjoxNzMyMTIxNDYwLCJpYXQiOjE3MzE5NTMwMzAsImp0aSI6InVaVWgxaERVUW82UEZrQlBud3BHemciLCJ1c2VybmFtZSI6IkRlZmF1bHQgQWRtaW4gVXNlciIsInN0YXR1cyI6eyJzdGF0dXNfbGlzdCI6eyJpZHgiOjMwNiwidXJpIjoiaHR0cHM6Ly9qYW5zLnRlc3QvamFucy1hdXRoL3Jlc3R2MS9zdGF0dXNfbGlzdCJ9fX0.Pt-Y7F-hfde_WP7ZYwyvvSS11rKYQWGZXTzjH_aJKC5VPxzOjAXqI3Igr6gJLsP1aOd9WJvOPchflZYArctopXMWClbX_TxpmADqyCMsz78r4P450TaMKj-WKEa9cL5KtgnFa0fmhZ1ZWolkDTQ_M00Xr4EIvv4zf-92Wu5fOrdjmsIGFot0jt-12WxQlJFfs5qVZ9P-cDjxvQSrO1wbyKfHQ_txkl1GDATXsw5SIpC5wct92vjAVm5CJNuv_PE8dHAY-KfPTxOuDYBuWI5uA2Yjd1WUFyicbJgcmYzUSVt03xZ0kQX9dxKExwU2YnpDorfwebaAPO7G114Bkw208g";

        // Payload of id_token:
        // {
        //   "sub": "qzxn1Scrb9lWtGxVedMCky-Ql_ILspZaQA6fyuYktw0",
        //   "code": "3e2a2012-099c-464f-890b-448160c2ab25",
        //   "iss": "https://account.gluu.org",
        //   "token_type": "Bearer",
        //   "client_id": "d7f71bea-c38d-4caf-a1ba-e43c74a11a62",
        //   "aud": "d7f71bea-c38d-4caf-a1ba-e43c74a11a62",
        //   "acr": "simple_password_auth",
        //   "x5t#S256": "",
        //   "nbf": 1731953030,
        //   "scope": [
        //     "role",
        //     "openid",
        //     "profile",
        //     "email"
        //   ],
        //   "auth_time": 1731953027,
        //   "exp": 1732121460,
        //   "iat": 1731953030,
        //   "jti": "uZUh1hDUQo6PFkBPnwpGzg",
        //   "username": "Default Admin User",
        //   "status": {
        //     "status_list": {
        //       "idx": 306,
        //       "uri": "https://jans.test/jans-auth/restv1/status_list"
        //     }
        //   }
        // }
        let ID_TOKEN = "eyJraWQiOiJjb25uZWN0X2Y5YTAwN2EyLTZkMGItNDkyYS05MGNkLWYwYzliMWMyYjVkYl9zaWdfcnMyNTYiLCJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJhdF9oYXNoIjoiYnhhQ1QwWlFYYnY0c2J6alNEck5pQSIsInN1YiI6InF6eG4xU2NyYjlsV3RHeFZlZE1Da3ktUWxfSUxzcFphUUE2Znl1WWt0dzAiLCJhbXIiOltdLCJpc3MiOiJodHRwczovL2FjY291bnQuZ2x1dS5vcmciLCJub25jZSI6IjI1YjJiMTZiLTMyYTItNDJkNi04YThlLWU1ZmE5YWI4ODhjMCIsInNpZCI6IjZkNDQzNzM0LWI3YTItNGVkOC05ZDNhLTE2MDZkMmY5OTI0NCIsImphbnNPcGVuSURDb25uZWN0VmVyc2lvbiI6Im9wZW5pZGNvbm5lY3QtMS4wIiwiYXVkIjoiZDdmNzFiZWEtYzM4ZC00Y2FmLWExYmEtZTQzYzc0YTExYTYyIiwiYWNyIjoic2ltcGxlX3Bhc3N3b3JkX2F1dGgiLCJjX2hhc2giOiJWOGg0c085Tnp1TEthd1BPLTNETkxBIiwibmJmIjoxNzMxOTUzMDMwLCJhdXRoX3RpbWUiOjE3MzE5NTMwMjcsImV4cCI6MTczMTk1NjYzMCwiZ3JhbnQiOiJhdXRob3JpemF0aW9uX2NvZGUiLCJpYXQiOjE3MzE5NTMwMzAsImp0aSI6ImlqTFpPMW9vUnlXcmdJbjdjSWROeUEiLCJzdGF0dXMiOnsic3RhdHVzX2xpc3QiOnsiaWR4IjozMDcsInVyaSI6Imh0dHBzOi8vamFucy50ZXN0L2phbnMtYXV0aC9yZXN0djEvc3RhdHVzX2xpc3QifX19.Nw7MRaJ5LtDak_LdEjrICgVOxDwd1p1I8WxD7IYw0_mKlIJ-J_78rGPski9p3L5ZNCpXiHtVbnhc4lJdmbh-y6mrD3_EY_AmjK50xpuf6YuUuNVtFENCSkj_irPLkIDG65HeZherWsvH0hUn4FVGv8Sw9fjny9Doi-HGHnKg9Qvphqre1U8hCphCVLQlzXAXmBkbPOC8tDwId5yigBKXP50cdqDcT-bjXf9leIdGgq0jxb57kYaFSElprLN9nUygM4RNCn9mtmo1l4IsdTlvvUb3OMAMQkRLfMkiKBjjeSF3819mYRLb3AUBaFH16ZdHFBzTSB6oA22TYpUqOLihMg";

        // Payload of userinfo_token:
        // {
        //   "sub": "qzxn1Scrb9lWtGxVedMCky-Ql_ILspZaQA6fyuYktw0",
        //   "email_verified": true,
        //   "role": [
        //     "CasaAdmin"
        //   ],
        //   "iss": "https://account.gluu.org",
        //   "given_name": "Admin",
        //   "middle_name": "Admin",
        //   "inum": "a6a70301-af49-4901-9687-0bcdcf4e34fa",
        //   "client_id": "d7f71bea-c38d-4caf-a1ba-e43c74a11a62",
        //   "aud": "d7f71bea-c38d-4caf-a1ba-e43c74a11a62",
        //   "updated_at": 1731698135,
        //   "name": "Default Admin User",
        //   "nickname": "Admin",
        //   "family_name": "User",
        //   "jti": "OIn3g1SPSDSKAYDzENVoug",
        //   "email": "admin@jans.test",
        //   "jansAdminUIRole": [
        //     "api-admin"
        //   ]
        // }
        let USERINFO_TOKEN = "eyJraWQiOiJjb25uZWN0X2Y5YTAwN2EyLTZkMGItNDkyYS05MGNkLWYwYzliMWMyYjVkYl9zaWdfcnMyNTYiLCJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJzdWIiOiJxenhuMVNjcmI5bFd0R3hWZWRNQ2t5LVFsX0lMc3BaYVFBNmZ5dVlrdHcwIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsInJvbGUiOlsiQ2FzYUFkbWluIl0sImlzcyI6Imh0dHBzOi8vYWNjb3VudC5nbHV1Lm9yZyIsImdpdmVuX25hbWUiOiJBZG1pbiIsIm1pZGRsZV9uYW1lIjoiQWRtaW4iLCJpbnVtIjoiYTZhNzAzMDEtYWY0OS00OTAxLTk2ODctMGJjZGNmNGUzNGZhIiwiY2xpZW50X2lkIjoiZDdmNzFiZWEtYzM4ZC00Y2FmLWExYmEtZTQzYzc0YTExYTYyIiwiYXVkIjoiZDdmNzFiZWEtYzM4ZC00Y2FmLWExYmEtZTQzYzc0YTExYTYyIiwidXBkYXRlZF9hdCI6MTczMTY5ODEzNSwibmFtZSI6IkRlZmF1bHQgQWRtaW4gVXNlciIsIm5pY2tuYW1lIjoiQWRtaW4iLCJmYW1pbHlfbmFtZSI6IlVzZXIiLCJqdGkiOiJPSW4zZzFTUFNEU0tBWUR6RU5Wb3VnIiwiZW1haWwiOiJhZG1pbkBqYW5zLnRlc3QiLCJqYW5zQWRtaW5VSVJvbGUiOlsiYXBpLWFkbWluIl19.CIahQtRpoTkIQx8KttLPIKH7gvGG8OmYCMzz7wch6k792DVYQG1R7q3sS9Ema1rO5Fm_GgjOsR0yTTMKsyhHDLBwkDd3cnMLgsh2AwVFZvxtpafTlUAPfjvMAy9YTtkPcY6rNUhsYLSSOA83kt6pHdIv5nI-G6ybqgg-bLBRpwZDoOV0TulRhmuukdiuugTXHT6Bb-K3ZeYs8CwewztnxoFTSDghSzq7VZIraV8SLTBLx5_xswn9mefamyB2XNN3o6vXuMyf4BEbYSCuJ3pu6YtNgfyWwt9cF8PYe4PVLoXZuJKN-cy4qrtgy43QXPCg96jSQUJqgLb5ZL5_3udm2Q";

        let DEFAULT_REQUEST = JSON.stringify({
            "access_token": ACCESS_TOKEN,
            "id_token": ID_TOKEN,
            "userinfo_token": USERINFO_TOKEN,
            "action": 'Jans::Action::"Read"',
            "resource": {
                "type": "Jans::Application",
                "id": "some_id",
                "app_id": "application_id",
                "name": "Some Application",
                "url": {
                    "host": "jans.test",
                    "path": "/protected-endpoint",
                    "protocol": "http"
                }
            },
            "context": {
                "current_time": Math.floor(Date.now() / 1000),
                "device_health": ["Healthy"],
                "fraud_indicators": ["Allowed"],
                "geolocation": ["America"],
                "network": "127.0.0.1",
                "network_type": "Local",
                "operating_system": "Linux",
                "user_agent": "Linux"
            },
        }, null, 2);

        // Program strart here

        // Define links to div in body
        const bootstrap_config_textarea = $('#bootstrap_config_textarea');
        const bootstrap_init_button = $('#bootstrap_init_button');
        const bootstrap_init_processing = $('#bootstrap_init_processing');
        const bootstrap_init_success = $('#bootstrap_init_success');
        const bootstrap_init_error = $('#bootstrap_init_error');
        const bootstrap_init_log_panel = $('#bootstrap_init_log_panel');
        const bootstrap_init_log_values = $('#bootstrap_init_log_values');
        const authorize_request_div = $('#authorize_request_div');

        const request_textarea = $('#request_textarea');
        const request_button = $('#request_button');
        const request_processing = $('#request_processing');
        const request_error = $('#request_error');
        const request_result_panel = $('#request_result_panel');
        const request_result_values = $('#request_result_values');
        const request_log_panel = $('#request_log_panel');
        const request_log_values = $('#request_log_values');


        // set default bootstrap config to textarea
        bootstrap_config_textarea.val(RAW_DEFAULT_BOOTSTRAP_CONFIG);


        // function to initialize cedarling on button with id `bootstrap_init_button`
        bootstrap_init_button.on('click', async function () {
            bootstrap_init_button.hide();
            bootstrap_init_processing.show();
            try {
                let bootsrap_config_str = bootstrap_config_textarea.val();
                let bootsrap_config_json = JSON.parse(bootsrap_config_str);

                // init cedarling
                const cedar_instance = await window.cedarling_init(bootsrap_config_json);
                window.cedar_instance = cedar_instance;

                let logs = cedar_instance.pop_logs();
                if (logs.length != 0) {
                    let pretty_logs = logs.map(log => JSON.stringify(Object.fromEntries(log), null, 2));

                    bootstrap_init_log_panel.show();
                    bootstrap_init_log_values.text(pretty_logs);
                } else {
                    bootstrap_init_log_panel.hide();
                };
                // show and hide div blocks when no errors
                bootstrap_init_error.hide();
                bootstrap_init_success.show();
                authorize_request_div.show();

                // if bootstrap config is not changed set default request to textarea
                if (bootsrap_config_str == RAW_DEFAULT_BOOTSTRAP_CONFIG) {
                    request_textarea.val(DEFAULT_REQUEST);
                }

            } catch (error) {
                // add error message to div
                bootstrap_init_error.text(error.message);
                bootstrap_init_error.show();
                bootstrap_init_success.hide();
                bootstrap_init_log_panel.hide();
                authorize_request_div.hide();
            } finally {
                bootstrap_init_button.show();
                bootstrap_init_processing.hide();
            }
        });


        // function to execute authorize on button with id `bootstrap_init_button`
        request_button.on('click', async function () {
            request_button.hide();
            request_processing.show();
            try {
                let request_json = JSON.parse(request_textarea.val());

                let auth_result = await window.cedar_instance.authorize(request_json);
                let auth_result_json = auth_result.json_string();

                // convert JSON to object and apply `JSON.stringify` to have pretty json string
                let auth_result_json_str = JSON.stringify(JSON.parse(auth_result_json), null, 2);

                request_result_values.text(auth_result_json_str);
                request_result_panel.show();

                let logs = window.cedar_instance.pop_logs();
                if (logs.length != 0) {
                    let pretty_logs = logs.map(log => JSON.stringify(Object.fromEntries(log), null, 2));

                    request_log_panel.show();
                    request_log_values.text(pretty_logs);
                } else {
                    request_log_panel.hide();
                };

                request_error.hide();
            } catch (error) {
                request_error.text(error.message);
                request_error.show();

                request_result_panel.hide();
                request_log_panel.hide();
            } finally {
                request_button.show();
                request_processing.hide();
            }
        });

    </script>
</body>

</html>