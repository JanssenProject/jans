name: Cedarling Testcases 

on:
  pull_request:
    branches:
      - main
    paths:
      - "jans-cedarling/**"
permissions:
  contents: read

jobs:
  rust_tests:
    runs-on: ubuntu-latest
    steps:
    - name: Harden Runner
      uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
      with:
        egress-policy: audit
    - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
    - name: Install Rust
      uses: dtolnay/rust-toolchain@efa25f7f19611383d5b0ccf2d1c8914531636bf9 # stable
      with:
        toolchain: stable
        components: clippy
    - name: Cache Rust dependencies
      uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
      with:
        workspaces: jans-cedarling
    - name: Run Tests
      working-directory: jans-cedarling
      run: cargo test --workspace
    - name: Run Clippy on native target
      working-directory: jans-cedarling
      run: cargo clippy --workspace --all-targets -- -D warnings

  custom_lints:
    runs-on: ubuntu-latest
    steps:
    - name: Harden Runner
      uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
      with:
        egress-policy: audit
    - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
    - name: Install Rust Nightly
      uses: dtolnay/rust-toolchain@efa25f7f19611383d5b0ccf2d1c8914531636bf9
      with:
        toolchain: nightly-2025-09-18
        components: llvm-tools-preview, rustc-dev
    - name: Install Rust Stable (for workspace)
      uses: dtolnay/rust-toolchain@efa25f7f19611383d5b0ccf2d1c8914531636bf9 # stable
      with:
        toolchain: stable
    - name: Cache Rust dependencies
      uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
      with:
        workspaces: jans-cedarling
    - uses: cargo-bins/cargo-binstall@v1.17.4
    - name: Install dylint
      run: |
        cargo binstall cargo-dylint --version 5.0.0 --locked --no-confirm
        cargo binstall dylint-link --version 5.0.0 --locked --no-confirm
    - name: Run Tests
      working-directory: jans-cedarling/custom-lints
      run: cargo test
    - name: Run custom lints on workspace
      working-directory: jans-cedarling
      run: |
        RUSTFLAGS="-Dwarnings" cargo dylint --all --workspace --path custom-lints

  rust_benchmarks:
    runs-on: ubuntu-latest
    steps:
    - name: Harden Runner
      uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
      with:
        egress-policy: audit
    - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
    - name: Install Rust
      uses: dtolnay/rust-toolchain@efa25f7f19611383d5b0ccf2d1c8914531636bf9 # stable
      with:
        toolchain: stable
    - name: Cache Rust dependencies
      uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
      with:
        workspaces: jans-cedarling
    - name: Run benchmarks
      working-directory: jans-cedarling
      run: cargo bench --profile release
    - name: Run script to analyze benchmarks
      working-directory: jans-cedarling
      run: python3 scripts/check_benchmarks.py

  wasm_tests:
    runs-on: ubuntu-latest
    steps:
    - name: Harden Runner
      uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
      with:
        egress-policy: audit

    - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

    - name: Install chromium
      run: sudo apt-get update && sudo apt-get install chromium-chromedriver

    - name: Install Rust Stable
      uses: dtolnay/rust-toolchain@efa25f7f19611383d5b0ccf2d1c8914531636bf9 # stable
      with:
        toolchain: stable
        components: clippy
        targets: wasm32-unknown-unknown

    - name: Cache Rust dependencies
      uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
      with:
        workspaces: jans-cedarling

    - name: Install specific wasm-pack version (v0.13.1)
      run: |
        curl -L https://github.com/rustwasm/wasm-pack/releases/download/v0.13.1/wasm-pack-v0.13.1-x86_64-unknown-linux-musl.tar.gz | tar xz -C /usr/local/bin --strip-components=1
        wasm-pack --version

    - name: Run WASM tests using chrome
      working-directory: jans-cedarling/bindings/cedarling_wasm
      run: wasm-pack test --headless --chrome

    - name: Run WASM tests using firefox
      working-directory: jans-cedarling/bindings/cedarling_wasm
      run: wasm-pack test --headless --firefox

    - name: Run Clippy on WASM target
      working-directory: jans-cedarling
      run: cargo clippy -p cedarling_wasm --target wasm32-unknown-unknown -- -D warnings

  python_tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.11"]
    steps:
    - name: Harden Runner
      uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
      with:
        egress-policy: audit
    - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
      with:
        python-version: ${{ matrix.python-version }}
    - name: Install dependencies
      run: |
        python3 -m pip install --upgrade pip || echo "Failed to upgrade pip"
        python3 -m pip install tox
    - name: Test with pytest
      working-directory: jans-cedarling/bindings/cedarling_python
      run: tox

  golang_tests:
    runs-on: ubuntu-latest
    steps:
    - name: Harden Runner
      uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
      with:
        egress-policy: audit
    - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
    - name: Install Rust
      uses: dtolnay/rust-toolchain@efa25f7f19611383d5b0ccf2d1c8914531636bf9 # stable
      with:
        toolchain: stable
    - name: Cache Rust dependencies
      uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
      with:
        workspaces: jans-cedarling
    - name: Install Golang dependencies
      uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
      with:
          go-version: '1.24'
    - name: Build Rust artifacts
      working-directory: jans-cedarling/bindings/cedarling_go
      run: |
        cargo build -r -p cedarling_go
        cp "../../target/release/libcedarling_go.so" "."
    - name: Install Go dependencies
      working-directory: jans-cedarling/bindings/cedarling_go
      run: go mod download && go mod tidy -v && git --no-pager diff --exit-code go.mod go.sum || (echo 'go.mod or go.sum changed; run go mod tidy and commit' && exit 1)
    - name: Run golang tests
      working-directory: jans-cedarling/bindings/cedarling_go
      run: |
        export LD_LIBRARY_PATH="$(pwd):${LD_LIBRARY_PATH}"
        go test .
