name: enrich sbom

on: [pull_request]
permissions:
  contents: read
jobs:
  enrich_sbom:
    if: github.repository == 'JanssenProject/jans'
    runs-on: ubuntu-latest
    steps:

    # TODO: add the correct secret
    - name: Fetch Jans SBOM
      run: |
        curl -H "Authorization: Bearer ${{ secrets.MOAUTO_WORKFLOW_TOKEN }}" \
              -H "Accept: application/vnd.github.v3.raw" \
              -o gh-sbom.json \
              https://api.github.com/repos/JanssenProject/jans/dependency-graph/sbom
        wc gh-sbom.json

    # Trim the SBOM to remove the parent `SBOM` element. 
    # install jq to trim the SBOM
    - name: Install jq
      run: |
        sudo apt-get update
        sudo apt-get install -y jq
  
    # Trim the SBOM to only have value of `SBOM` element
    - name: Trim SBOM
      run: |
        jq '.sbom' gh-sbom.json > trimmed-sbom.json
        wc trimmed-sbom.json

    # Install Parlay CLI
    - name: Install Parlay CLI
      run: |
        wget https://github.com/snyk/parlay/releases/download/v0.8.0/parlay_0.8.0_linux_amd64.deb
        sudo dpkg -i parlay_0.8.0_linux_amd64.deb

    # Enrich the SBOM using Parlay CLI with ecosystems and scorecard
    - name: Enrich trimmed SBOM using Parlay
      run: |
        cat trimmed-sbom.json | \
        parlay ecosystems enrich - | \
        parlay scorecard enrich - > enriched-sbom.json
        # debug
        wc enriched-sbom.json 

    # install sbomqs
    - name: Install sbomqs
      run: |
        # get binary from latest release
        curl -s https://api.github.com/repos/interlynk-io/sbomqs/releases/latest | \
        grep "browser_download_url" | \
        grep -P "sbomqs_\d+\.\d+\.\d+_amd64.deb" | \
        cut -d '"' -f 4 | xargs curl -LO

        # install sbomqs
        sudo dpkg -i sbomqs_*_amd64.deb

    # Generate compliance reports using sbomqs
    - name: Generate compliance reports using sbomqs
      run: |        

        # generate Framing Software Component Transparency (v3) compliance report
        echo "Generating Framing Software Component Transparency (v3) compliance report"
        sbomqs compliance --fsct -j enriched-sbom.json > jans-sbom-fsct-report.json

        # generate BSI TR-03183-2 (v2.0.0) compliance report
        echo "Generating BSI TR-03183-2 (v2.0.0) compliance report"
        sbomqs compliance --bsi-v2 -j enriched-sbom.json > jans-sbom-bsi-v2-report.json

        # generate NTIA minimum elements (July 12, 2021) compliance report
        echo "Generating NTIA minimum elements (July 12, 2021) compliance report"
        sbomqs compliance --ntia -j enriched-sbom.json > jans-sbom-NTIA-report.json

        # generate OpenChain Telco SBOM (v1.0) compliance report
        echo "Generating OpenChain Telco SBOM (v1.0) compliance report"
        sbomqs compliance --oct -j enriched-sbom.json > jans-sbom-openchain-report.json


    #   # Upload the enriched SBOM to the release
    # - name: Upload the enriched SBOM to the release
    #   uses: svenstaro/upload-release-action@1beeb572c19a9242f4361f4cee78f8e0d9aec5df # v2
    #   with:
    #     repo_token: ${{ secrets.MOAUTO_WORKFLOW_TOKEN }}
    #     file: sbom.json
    #     asset_name: jans-sbom.json
    #     # tag: ${{ steps.previoustag.outputs.tag }}
    #     tag: ${{ github.event.ref }}
    #     overwrite: true