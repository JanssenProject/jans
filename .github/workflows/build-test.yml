name: Janssen Build & Test

on:
  push:
    branches:
      - main
    paths:
      - "jans-**"
      - "agama"
  schedule:
    - cron: '0 8 * * *'
  pull_request:
    branches:
      - main
    paths:
      - "jans-**"
      - "agama"
  workflow_dispatch:
    inputs:
      project:
        type: choice
        options:
          - "jans-bom"
          - "jans-orm"
          - "jans-core"
          - "jans-lock/lock-server"
          - "agama"
          - "jans-auth-server"
          - "jans-link"
          - "jans-fido2"
          - "jans-scim"
          - "jans-config-api"
          - "jans-casa"
          - "jans-shibboleth-idp"
          - "jans-bom jans-orm jans-core jans-lock/lock-server agama jans-auth-server jans-link jans-fido2 jans-scim jans-config-api jans-casa jans-shibboleth-idp"
        description: 'Service'
        required: true
        default: "jans-bom jans-orm jans-core jans-lock/lock-server agama jans-auth-server jans-link jans-fido2 jans-scim jans-config-api jans-casa jans-shibboleth-idp"
concurrency:
  group: run-once
  cancel-in-progress: false
permissions:
  contents: read
jobs:
  cleanup:
    runs-on: ubuntu-22.04
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    permissions:
      contents: read
      packages: write
    steps:
    - name: Harden Runner
      uses: step-security/harden-runner@a90bcbc6539c36a85cdfeb73f7e2f433735f215b # v2.15.0
      with:
        egress-policy: block
        allowed-endpoints: >
          api.github.com:443
          github.com:443

    - name: Delete 0.0.0-nightly Maven Packages
      id: purge_nightly
      run: |
        # Use a localized function to handle deletion safely
        delete_version() {
          local svc="$1"
          # Fetch version ID specifically for the nightly tag
          local vid
          vid=$(gh api -H "Accept: application/vnd.github+json" \
            /orgs/JanssenProject/packages/maven/"${svc}"/versions \
            --jq '.[] | select(.name == "0.0.0-nightly") | .id' 2>/dev/null || echo "")
          
          if [ -n "$vid" ]; then
            echo "Deleting version $vid of $svc"
            gh api --method DELETE \
              -H "Accept: application/vnd.github+json" \
              /orgs/JanssenProject/packages/maven/"${svc}"/versions/"${vid}" || echo "Skip $svc (likely already gone)"
          fi
        }

        # Iterate through pages of packages
        page=1
        while true; do
          current_page_svcs=$(gh api -H "Accept: application/vnd.github+json" \
            "/orgs/JanssenProject/packages?package_type=maven&per_page=100&page=$page" \
            --jq '.[].name' 2>/dev/null)
          
          if [ -z "$current_page_svcs" ]; then break; fi
          
          for service in $current_page_svcs; do
            delete_version "$service"
          done
          page=$((page + 1))
        done
