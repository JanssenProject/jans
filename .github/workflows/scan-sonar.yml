name: Code quality check

on:
  push:
    branches: [main]
    paths:
      - 'jans-**/**'
      - 'agama/**'
      - '!**/CHANGELOG.md'
      - '!**.txt'
  pull_request:
    types: [opened, synchronize]
    branches: [main]
    paths:
      - 'jans-**/**'
      - 'agama/**'
      - '!**/CHANGELOG.md'
      - '!**.txt'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  detect-changes:
    name: Detect changed modules
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has_changes: ${{ steps.set-matrix.outputs.has_changes }}
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@a90bcbc6539c36a85cdfeb73f7e2f433735f215b # v2.15.0
        with:
          egress-policy: block
          allowed-endpoints: >
            github.com:443
            api.github.com:443

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Detect changed modules
        id: set-matrix
        run: |
          ALL_MODULES="jans-auth-server agama jans-config-api jans-core jans-linux-setup jans-cli-tui jans-fido2 jans-orm jans-scim jans-pycloudlib jans-link jans-casa jans-lock jans-shibboleth-idp"
          
          # Use Git to find changed files based on event type
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            CHANGED_DIRS=$(echo "$ALL_MODULES" | tr ' ' '\n')
          elif [[ -n "${{ github.base_ref }}" ]]; then
            CHANGED_DIRS=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | cut -d/ -f1 | sort -u)
          else
            CHANGED_DIRS=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | cut -d/ -f1 | sort -u)
          fi

          # Safe intersection using jq
          CHANGED_MODULES=$(jq -n --arg all "$ALL_MODULES" --arg changed "$CHANGED_DIRS" '
            ($all | split(" ")) as $a | 
            ($changed | split("\n")) as $c | 
            ($a & $c) | join(" ")' | tr -d '"')

          if [ -z "$CHANGED_MODULES" ]; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            echo "matrix={\"module\":[]}" >> "$GITHUB_OUTPUT"
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            JSON=$(echo "$CHANGED_MODULES" | tr ' ' '\n' | jq -R . | jq -sc '{"module": .}')
            echo "matrix=$JSON" >> "$GITHUB_OUTPUT"
          fi

  sonar-scan:
    name: Sonar Scan
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.detect-changes.outputs.matrix) }}
    permissions:
      contents: read
      pull-requests: write
    env:
      JVM_PROJECTS: "jans-link jans-auth-server jans-lock jans-orm jans-config-api jans-scim jans-core jans-fido2 jans-casa agama jans-shibboleth-idp"
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@a90bcbc6539c36a85cdfeb73f7e2f433735f215b # v2.15.0
        with:
          egress-policy: block
          allowed-endpoints: >
            api.github.com:443
            github.com:443
            objects.githubusercontent.com:443
            repo.maven.apache.org:443
            sonarcloud.io:443
            scanner.sonarcloud.io:443
            analysis.sonarcloud.io:443

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        if: contains(env.JVM_PROJECTS, matrix.module)
        uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5.2.0
        with:
          java-version: '17'
          distribution: 'adopt'
          cache: 'maven'

      - name: Build and analyze JVM project
        if: contains(env.JVM_PROJECTS, matrix.module)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          cd "${{ matrix.module }}"
          # Skip tests for specifically heavy modules as per original logic
          if [[ "${{ matrix.module }}" =~ ^(jans-auth-server|jans-lock|jans-scim|jans-config-api)$ ]]; then
            mvn -B -DskipTests=true install org.sonarsource.scanner.maven:sonar-maven-plugin:sonar
          else
            mvn -B install org.sonarsource.scanner.maven:sonar-maven-plugin:sonar
          fi

      - name: SonarCloud Scan (Non-JVM)
        if: "!contains(env.JVM_PROJECTS, matrix.module)"
        uses: SonarSource/sonarqube-scan-action@a31c9398be7ace6bbfaf30c0bd5d415f843d45e9 # v7.0.0
        with:
          args: >
            -Dsonar.organization=${{ github.repository_owner }}
            -Dsonar.projectKey=${{ github.repository_owner }}_${{ matrix.module }}
          projectBaseDir: ${{ matrix.module }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}