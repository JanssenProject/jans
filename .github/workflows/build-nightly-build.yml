name: Activate Nightly Build

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'The branch to build nightly release from'
        required: false
        default: 'main'
  schedule:
    - cron: "0 23 * * *"

permissions:
  contents: read

jobs:
  nightly:
    permissions:
      contents: write  # Necessary for: gh release create AND git push --delete
    runs-on: ubuntu-22.04
    steps:
    - name: Harden Runner
      uses: step-security/harden-runner@a90bcbc6539c36a85cdfeb73f7e2f433735f215b # v2.15.0
      with:
        egress-policy: block
        allowed-endpoints: >
          github.com:443
          api.github.com:443

    - name: Checkout
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

    - name: Set Nightly Version
      id: nightly
      if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        TARGET_BRANCH: ${{ github.event.inputs.branch || 'main' }}
        NIGHTLY_VERSION: "nightly"
      run: |
        # 1. Delete existing release & tag
        gh release delete "$NIGHTLY_VERSION" --cleanup-tag --yes || echo "No existing release"
        
        # 2. Delete the remote tag if it lingered
        git push origin --delete "$NIGHTLY_VERSION" || echo "Tag not found on remote"
        
        # 3. Create new release
        gh release create "$NIGHTLY_VERSION" \
          --generate-notes \
          --prerelease \
          --title "Nightly Build" \
          --target "$TARGET_BRANCH"