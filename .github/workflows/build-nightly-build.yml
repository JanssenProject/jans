name: Activate Nightly Build

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'The branch to build night release from'
        required: false
        default: 'main'
  schedule:
    - cron: "0 23 * * *"
permissions:
  contents: read

jobs:
  publish_binary_packages:
    permissions:
      contents: write  # for Git to git push
    runs-on: ubuntu-22.04
    steps:
    - name: Harden Runner
      uses: step-security/harden-runner@a90bcbc6539c36a85cdfeb73f7e2f433735f215b # v2.15.0
      with:
        egress-policy: audit

    - name: Checkout
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

    - name: set nightly version
      id: nightly
      continue-on-error: false
      if: github.event_name == 'schedule' || github.event.inputs.nightly == 'true'
      env:
        GH_TOKEN: ${{ secrets.MOAUTO_WORKFLOW_TOKEN }}
        TARGET_BRANCH: ${{ github.event.inputs.branch }}
      run: |
        NIGHTLY_VERSION="nightly"
        gh release delete "${NIGHTLY_VERSION}" --cleanup-tag --yes || echo "${NIGHTLY_VERSION} does not exist"
        git push --delete origin "${NIGHTLY_VERSION}" || echo "${NIGHTLY_VERSION} tag does not exist"
        if [ -z "$TARGET_BRANCH" ]; then
          TARGET_BRANCH="main"
        fi
        gh release create "${NIGHTLY_VERSION}" --generate-notes --prerelease --title "${NIGHTLY_VERSION}" --target "${TARGET_BRANCH}"