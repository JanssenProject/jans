name: mysql
on:
  push:
    branches:
      - master
      - main
    paths:
      - "helm/**"
  pull_request:
    branches:
      - master
      - main
    paths:
      - "helm/**"
  workflow_dispatch:
jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Test dev setup
      id: microk8s
      run: |
          chmod u+x automation/startjanssendemo.sh
          (echo "demoexample.jans.io" && cat ) | sudo bash ./automation/startjanssendemo.sh

    - name: Test Janssen authorization server with mysql backend
      id: test_kubernetes
      run: |
          sudo microk8s kubectl get po -n jans --kubeconfig="$PWD/config"
          sleep 30
          sudo microk8s kubectl get po -n jans --kubeconfig="$PWD/config"
          sudo microk8s kubectl -n jans wait --for=condition=available --timeout=600s deploy/janssen-auth-server --kubeconfig="$PWD/config" || sudo microk8s kubectl logs -l APP_NAME=auth-server -c auth-server -n jans --kubeconfig="$PWD/config" || echo "Not Found"
          sudo microk8s kubectl get po -n jans --kubeconfig="$PWD/config" || echo "Not Found"
          sudo microk8s kubectl logs -l APP_NAME=persistence-loader -c persistence -n jans --kubeconfig="$PWD/config"
          sudo microk8s kubectl get po --kubeconfig="$PWD/config" || echo "Not Found"
          sudo microk8s kubectl -n jans wait --for=condition=available --timeout=300s deploy/janssen-client-api --kubeconfig="$PWD/config" || sudo microk8s kubectl logs -l APP_NAME=client-api -c client-api -n jans --kubeconfig="$PWD/config" || echo "Not Found"
          sudo microk8s kubectl get po -n jans --kubeconfig="$PWD/config" || echo "Not Found"
          sudo microk8s kubectl logs -l APP_NAME=persistence-loader -c persistence -n jans --kubeconfig="$PWD/config"
          sudo microk8s kubectl -n jans wait --for=condition=available --timeout=300s deploy/janssen-fido2 --kubeconfig="$PWD/config" || sudo microk8s kubectl logs -l APP_NAME=fido2 -c fido2 -n jans --kubeconfig="$PWD/config" || echo "Not Found"
          sudo microk8s kubectl get po -n jans --kubeconfig="$PWD/config" || echo "Not Found"
          sudo microk8s kubectl logs -l APP_NAME=persistence-loader -c persistence -n jans --kubeconfig="$PWD/config"
          sudo microk8s kubectl -n jans wait --for=condition=available --timeout=300s deploy/janssen-scim --kubeconfig="$PWD/config" || sudo microk8s kubectl logs -l APP_NAME=scim -c scim -n jans --kubeconfig="$PWD/config" || echo "Not Found"
          sudo microk8s kubectl get po -n jans --kubeconfig="$PWD/config" || echo "Not Found"
