name: Build Deb Package

on:
  push:
    tags:
    - '*'

  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - run: git clone -b jans https://github.com/GluuFederation/packaging
    - run: mkdir -p jans/jans-src/opt/
    - run: cp -rp packaging/deb/focal/* jans/
    - run: wget https://raw.githubusercontent.com/JanssenProject/jans/main/jans-linux-setup/jans_setup/install.py -O jans/install.py
    - run: sudo apt install -y python3-distutils python3-ldap3 build-essential devscripts debhelper
    - name: Running install
      run: |
         cd jans/
         sudo python3.8 install.py --no-setup
         cp -r /opt/dist jans-src/opt/
         cp -r /opt/jans jans-src/opt/
         touch jans-src/opt/jans/jans-setup/package
         rm -rf install.py install jans-cli
         sed -i "s/%VERSION%/${GITHUB_REF##*/}/g" debian/changelog
         sed -i "s/%VERSION%/${GITHUB_REF##*/}/g" run-build.sh
         sudo ./run-build.sh
    - name: Upload binaries to release
      uses: svenstaro/upload-release-action@v2
      with:
        repo_token: ${{ secrets.MOWORKFLOWTOKEN }}
        file: ${{github.workspace}}/jans/jans_${{ github.ref_name }}~ubuntu20.04_amd64.deb
        asset_name: jans_${{ github.ref_name }}~ubuntu20.04_amd64.deb
        tag: ${{ github.ref }}        
