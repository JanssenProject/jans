name: Publish packages

on:
  push:
    tags:
    - 'v**'
    - 'nightly'
  workflow_dispatch:
    inputs:
      target_tag:
        description: 'The release tag to upload assets to (e.g., v1.0.1 or nightly). Required.'
        required: true
        type: string
      run_binary_packages:
        description: 'Run "publish_binary_packages" job?'
        required: true
        type: boolean
        default: false
      run_python_packages:
        description: 'Run "build_and_upload_python_packages" job?'
        required: true
        type: boolean
        default: false
      run_cedarling_wasm:
        description: 'Run "build_cedarling_wasm" job?'
        required: true
        type: boolean
        default: false
      run_demo_packages:
        description: 'Run "build_demo_packages" job? (Needs wasm)'
        required: true
        type: boolean
        default: false
      run_cedarling_python:
        description: 'Run "build_cedarling_python" job?'
        required: true
        type: boolean
        default: false
      run_cedarling_go:
        description: 'Run "build_cedarling_go" job?'
        required: true
        type: boolean
        default: false
      run_cedarling_krakend:
        description: 'Run "build_cedarling_krakend" job? (Needs go)'
        required: true
        type: boolean
        default: false
      run_cedarling_uniffi:
        description: 'Run "build_cedarling_uniffi" job?'
        required: true
        type: boolean
        default: false

permissions:
  contents: read

jobs:
  publish_binary_packages:
    if: |
      github.repository == 'JanssenProject/jans' &&
      (github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.run_binary_packages))
    runs-on: ${{ matrix.os }}
    permissions:
      id-token: write
      contents: write
    strategy:
      fail-fast: false
      matrix:
        name: [ubuntu24, ubuntu22, debian13, el9, el10, suse16]
        include:
          - name: ubuntu24
            os: ubuntu-22.04
            asset_suffix: ~ubuntu24.04_amd64.deb
            build_files: deb/noble
            asset_prefix: '_'
            asset_path: jans
            python_version: 3.11
          - name: ubuntu22
            os: ubuntu-22.04
            asset_suffix: ~ubuntu22.04_amd64.deb
            build_files: deb/jammy
            asset_prefix: '_'
            asset_path: jans
            python_version: 3.10
          - name: debian13
            os: ubuntu-22.04
            asset_suffix: ~debian13_amd64.deb
            build_files: deb/trixie
            asset_prefix: '_'
            asset_path: jans
            python_version: 3.11
          - name: el9
            os: ubuntu-22.04
            asset_suffix: .el9.x86_64.rpm
            build_files: rpm/el9
            asset_prefix: '-'
            asset_path: jans/rpmbuild/RPMS/x86_64
            python_version: 3.11
          - name: el10
            os: ubuntu-22.04
            asset_suffix: .el10.x86_64.rpm
            build_files: rpm/el10
            asset_prefix: '-'
            asset_path: jans/rpmbuild/RPMS/x86_64
            python_version: 3.11
          - name: suse16
            os: ubuntu-24.04
            asset_suffix: .suse16.x86_64.rpm
            build_files: rpm/suse16
            asset_prefix: '-'
            asset_path: jans/rpmbuild/RPMS/x86_64
            python_version: 3.11

    steps:
    - name: Harden Runner
      uses: step-security/harden-runner@a90bcbc6539c36a85cdfeb73f7e2f433735f215b # v2.15.0
      with:
        egress-policy: block
        allowed-endpoints: >
          api.github.com:443
          github.com:443
          objects.githubusercontent.com:443
          ppa.launchpadcontent.net:443
          azure.archive.ubuntu.com:80
          esm.ubuntu.com:443
          pypi.org:443
          files.pythonhosted.org:443
          fulcio.sigstore.dev:443
          rekor.sigstore.dev:443

    - name: Checkout
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      with:
        path: temp-jans

    - name: Get tag and version
      id: previoustag
      env:
        INPUT_TAG: ${{ github.event.inputs.target_tag }}
        EVENT_REF: ${{ github.event.ref }}
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          TAG_NAME="$INPUT_TAG"
        else
          TAG_NAME=$(echo "$EVENT_REF" | cut -d '/' -f 3)
        fi
        echo "tag=${TAG_NAME}" >> $GITHUB_OUTPUT
        if [[ "${TAG_NAME}" == "nightly" ]]; then
          echo "version=0.0.0-nightly" >> $GITHUB_OUTPUT
        else
          echo "version=$(echo "${TAG_NAME}" | sed 's/^v//')-stable" >> $GITHUB_OUTPUT
        fi
        echo "PACKAGE_PREFIX=jans" >> ${GITHUB_ENV}

    - name: Getting build dependencies
      run: |
         mkdir -p jans/jans-src/opt/
         cp -rp temp-jans/automation/packaging/${{ matrix.build_files }}/* jans/
         cp temp-jans/jans-linux-setup/jans_setup/install.py jans/install.py
         sudo add-apt-repository -y ppa:deadsnakes/ppa
         sudo apt-get update
         sudo apt-get install -y python${{ matrix.python_version }}
         sudo apt install -y build-essential devscripts debhelper rpm python3-dev libpq-dev python${{ matrix.python_version }}-dev apache2 rsyslog postgresql postgresql-contrib
         sudo apt install -y python${{ matrix.python_version }}-distutils 2>/dev/null || sudo apt install -y python3-distutils 2>/dev/null || echo "distutils not available"
         sudo python${{ matrix.python_version }} -m pip install --break-system-packages cryptography urllib3 certifi requests ruamel.yaml pymysql psycopg2-binary || echo "pip install partially failed"

    - name: Running install and build
      env:
        VER_TAG: ${{ steps.previoustag.outputs.version }}
      run: |
         cd jans/
         sudo python${{ matrix.python_version }} install.py -download-exit -yes --keep-downloads --keep-setup -force-download
         cp -r /opt/dist jans-src/opt/
         cp -r /opt/jans jans-src/opt/
         touch jans-src/opt/jans/jans-setup/package
         rm -rf install.py install jans-cli-tui
         rm -rf jans-src/opt/jans/jans-setup/logs/setup.log
         sed -i "s/%VERSION%/$VER_TAG/g" run-build.sh
         sudo ./run-build.sh

    - name: Install Cosign
      uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0

    - name: Sign package
      env:
        VER_TAG: ${{ steps.previoustag.outputs.version }}
      run: |
        ARTIFACT="${{github.workspace}}/${{ matrix.asset_path }}/jans${{ matrix.asset_prefix }}${VER_TAG}${{ matrix.asset_suffix }}"
        cosign sign-blob --yes --bundle cosign.bundle "${ARTIFACT}"

    - name: Upload binaries to release
      uses: svenstaro/upload-release-action@b98a3b12e86552593f3e4e577ca8a62aa2f3f22b # v2
      with:
        repo_token: ${{ secrets.MOAUTO_WORKFLOW_TOKEN }}
        file: ${{github.workspace}}/${{ matrix.asset_path }}/jans${{ matrix.asset_prefix }}${{ steps.previoustag.outputs.version }}${{ matrix.asset_suffix }}
        asset_name: ${{ env.PACKAGE_PREFIX }}${{ matrix.asset_prefix }}${{ steps.previoustag.outputs.version }}${{ matrix.asset_suffix }}
        tag: ${{ steps.previoustag.outputs.tag }}
        overwrite: true

    - name: Upload cosign bundle to release
      uses: svenstaro/upload-release-action@b98a3b12e86552593f3e4e577ca8a62aa2f3f22b # v2
      with:
        repo_token: ${{ secrets.MOAUTO_WORKFLOW_TOKEN }}
        file: ${{github.workspace}}/cosign.bundle
        asset_name: ${{ env.PACKAGE_PREFIX }}${{ matrix.asset_prefix }}${{ steps.previoustag.outputs.version }}${{ matrix.asset_suffix }}.sigstore.json
        tag: ${{ steps.previoustag.outputs.tag }}
        overwrite: true

  build_and_upload_python_packages:
    if: |
      github.repository == 'JanssenProject/jans' &&
      (github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.run_python_packages))
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: ubuntu
            os: ubuntu-22.04
            python_version: '3.10'
          - name: suse
            os: ubuntu-24.04
            python_version: '3.10'
            use_docker: true
            docker_image: opensuse/tumbleweed@sha256:46a7e0d003097de8b74079d5ed2bf6741329311a4a562f33677b252ea0eee228
          - name: macos
            os: macos-latest
            python_version: '3.10'
    steps:
    - name: Harden Runner
      uses: step-security/harden-runner@a90bcbc6539c36a85cdfeb73f7e2f433735f215b # v2.15.0
      with:
        egress-policy: block
        allowed-endpoints: >
          api.github.com:443
          github.com:443
          objects.githubusercontent.com:443
          pypi.org:443
          files.pythonhosted.org:443
          auth.docker.io:443
          registry-1.docker.io:443
          production.cloudflare.docker.com:443

    - name: Checkout
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

    - name: Set up Python
      if: matrix.name != 'suse'
      uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
      with:
        python-version: ${{ matrix.python_version }}

    - name: Build with Docker (SUSE)
      if: matrix.use_docker
      run: |
        docker run --rm -v "${{ github.workspace }}:/workspace" -w /workspace ${{ matrix.docker_image }} bash -c '
          zypper --gpg-auto-import-keys refresh
          zypper --non-interactive install -y gcc-c++ make gcc automake autoconf libtool openssl python311 python311-pip python311-setuptools python311-wheel python311-devel
          python3.11 -m pip install shiv
          cd /workspace/jans-linux-setup
          python3.11 -m shiv --compressed -o jans-linux-setup.pyz -p "/usr/bin/env python3" -e jans_setup.jans_setup:main . --no-cache
          mv jans-linux-setup.pyz jans-linux-suse-X86-64-setup.pyz
          cd ../jans-cli-tui
          python3.11 -m shiv --compressed -o jans-cli-tui.pyz -p "/usr/bin/env python3" -e cli_tui.jans_cli_tui:run . --no-cache
          mv jans-cli-tui.pyz jans-cli-tui-linux-suse-X86-64.pyz
        '

    - name: Build with Ubuntu
      if: matrix.name == 'ubuntu'
      run: |
        sudo apt-get update
        sudo apt-get install -y python3 build-essential ca-certificates dbus systemd iproute2 gpg python3-pip python3-dev libpq-dev gcc
        python3 -m pip install --upgrade pip
        pip3 install shiv wheel setuptools
        sudo chown -R runner:docker /home/runner/work/jans/jans        
        cd jans-linux-setup
        make zipapp || echo "Failed"
        mv jans-linux-setup.pyz jans-linux-ubuntu-X86-64-setup.pyz
        cd ../jans-cli-tui
        make zipapp 
        mv jans-cli-tui.pyz jans-cli-tui-linux-ubuntu-X86-64.pyz

    - name: Build with macOS
      if: matrix.name == 'macos'
      run: |
        python3 -m pip install --upgrade pip
        pip3 install shiv wheel setuptools
        cd jans-linux-setup
        make zipapp
        mv jans-linux-setup.pyz jans-linux-macos-setup.pyz
        cd ../jans-cli-tui
        make zipapp 
        mv jans-cli-tui.pyz jans-cli-tui-macos.pyz

    - name: Get tag and version
      id: previoustag
      env:
        INPUT_TAG: ${{ github.event.inputs.target_tag }}
        EVENT_REF: ${{ github.event.ref }}
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          TAG_NAME="$INPUT_TAG"
        else
          TAG_NAME=$(echo "$EVENT_REF" | cut -d '/' -f 3)
        fi
        echo "tag=${TAG_NAME}" >> $GITHUB_OUTPUT
        echo "SETUP_PREFIX=jans-linux" >> ${GITHUB_ENV}
        echo "TUI_PREFIX=jans-cli-tui-linux" >> ${GITHUB_ENV}

    - name: Upload setup binaries to release
      uses: svenstaro/upload-release-action@b98a3b12e86552593f3e4e577ca8a62aa2f3f22b # v2
      with:
        repo_token: ${{ secrets.MOAUTO_WORKFLOW_TOKEN }}
        file: ${{github.workspace}}/jans-linux-setup/jans-linux-${{ matrix.name }}-${{ matrix.name == 'macos' && 'setup' || 'X86-64-setup' }}.pyz
        asset_name: ${{ env.SETUP_PREFIX }}-${{ matrix.name }}-${{ matrix.name == 'macos' && 'setup' || 'X86-64-setup' }}.pyz
        tag: ${{ steps.previoustag.outputs.tag }}
        overwrite: true

  build_cedarling_wasm:
    if: |
      github.repository == 'JanssenProject/jans' &&
      (github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.run_cedarling_wasm))
    runs-on: ubuntu-22.04
    permissions:
      id-token: write
      contents: write
    steps:
    - name: Harden Runner
      uses: step-security/harden-runner@a90bcbc6539c36a85cdfeb73f7e2f433735f215b # v2.15.0
      with:
        egress-policy: block
        allowed-endpoints: >
          api.github.com:443
          github.com:443
          registry.npmjs.org:443
          static.rust-lang.org:443
          crates.io:443
          index.crates.io:443
          fulcio.sigstore.dev:443
          rekor.sigstore.dev:443

    - name: Checkout
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

    - name: Setup Node.js
      uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
      with:
        node-version: '20.x'
        registry-url: 'https://registry.npmjs.org'

    - name: Install Rust
      uses: dtolnay/rust-toolchain@efa25f7f19611383d5b0ccf2d1c8914531636bf9 # stable

    - name: Build WASM and Publish NPM
      id: build-wasm
      working-directory: ./jans-cedarling/bindings/cedarling_wasm
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        INPUT_TAG: ${{ github.event.inputs.target_tag }}
        EVENT_REF: ${{ github.event.ref }}
      run: |
        rustup target add wasm32-unknown-unknown
        cargo install wasm-pack
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          TAG_NAME="$INPUT_TAG"
        else
          TAG_NAME=$(echo "$EVENT_REF" | cut -d '/' -f 3)
        fi
        TAG=$(echo "${TAG_NAME}" | sed 's/^v//')
        
        # Safe NPM versioning logic
        if [ "${TAG}" == "nightly" ]; then
          NPM_TAG=nightly
          LAST_NIGHTLY=$(npm view @janssenproject/cedarling_wasm dist-tags.nightly || echo "0.0.0")
          PUB_VER=$(echo $LAST_NIGHTLY | awk -F. '{print $1"."$2"."$3+1}')
        else
          NPM_TAG=latest
          PUB_VER="${TAG}"
        fi
        
        sed -i "s/^version = \".*\"/version = \"${PUB_VER}\"/" Cargo.toml
        wasm-pack build --release --target web --scope janssenproject
        cd pkg && npm publish --provenance --access=public --tag "${NPM_TAG}" && cd ..
        
        # Node target
        NODE_VER="${PUB_VER}-nodejs"
        sed -i "s/^version = \".*\"/version = \"${NODE_VER}\"/" Cargo.toml
        wasm-pack build --release --target nodejs --scope janssenproject --out-dir pkg-nodejs
        cd pkg-nodejs && npm publish --provenance --access=public --tag "${NPM_TAG}-nodejs"

    - name: Archive and Sign
      env:
        GH_TOKEN: ${{ secrets.MOAUTO_WORKFLOW_TOKEN }}
        INPUT_TAG: ${{ github.event.inputs.target_tag }}
      run: |
        TAG_NAME=$([[ "${{ github.event_name }}" == "workflow_dispatch" ]] && echo "$INPUT_TAG" || echo "${{ github.event.ref }}" | cut -d '/' -f 3)
        TAG=$(echo "${TAG_NAME}" | sed 's/^v//')
        [[ "${TAG}" == "nightly" ]] && TAG="0.0.0"
        
        cd jans-cedarling/bindings/cedarling_wasm
        tar -czvf cedarling_wasm_"${TAG}"_pkg.tar.gz -C pkg .
        cosign sign-blob --yes --bundle bundle.json cedarling_wasm_"${TAG}"_pkg.tar.gz
        gh release upload "${TAG_NAME}" *.tar.gz *.json --clobber

  build_demo_packages:
    if: |
      github.repository == 'JanssenProject/jans' &&
      (github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.run_demo_packages))
    needs: build_cedarling_wasm
    runs-on: ubuntu-latest
    steps:
    - name: Harden Runner
      uses: step-security/harden-runner@a90bcbc6539c36a85cdfeb73f7e2f433735f215b # v2.15.0
      with:
        egress-policy: block
        allowed-endpoints: >
          api.github.com:443
          github.com:443
          objects.githubusercontent.com:443
          addons.mozilla.org:443
          registry.npmjs.org:443

    - name: Checkout
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

    - name: Build Demo Extension
      env:
        GH_TOKEN: ${{ secrets.MOAUTO_WORKFLOW_TOKEN }}
        MOZ_KEY: ${{ secrets.MOZILLA_API_KEY }}
        MOZ_SECRET: ${{ secrets.MOZILLA_API_SECRET }}
        INPUT_TAG: ${{ github.event.inputs.target_tag }}
      run: |
        TAG_NAME=$([[ "${{ github.event_name }}" == "workflow_dispatch" ]] && echo "$INPUT_TAG" || echo "${{ github.event.ref }}" | cut -d '/' -f 3)
        cd demos/janssen-tarp/browser-extension
        
        # Download WASM artifact from earlier step safely
        gh release download "${TAG_NAME}" -p "cedarling_wasm_*.tar.gz"
        mkdir -p wasm && tar -xvf cedarling_wasm_*.tar.gz -C wasm
        
        npm install && npm run build
        cd dist/firefox
        npx web-ext sign --channel=unlisted --api-key="$MOZ_KEY" --api-secret="$MOZ_SECRET" || echo "Sign failed"
        cd ../../ && npm run pack
        gh release upload "${TAG_NAME}" ./release/*.zip ./dist/firefox/web-ext-artifacts/*.xpi --clobber

  build_cedarling_python:
    if: |
      github.repository == 'JanssenProject/jans' &&
      (github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.run_cedarling_python))
    runs-on: ubuntu-22.04
    permissions:
      id-token: write
      contents: write
    steps:
    - name: Harden Runner
      uses: step-security/harden-runner@a90bcbc6539c36a85cdfeb73f7e2f433735f215b # v2.15.0
      with:
        egress-policy: block
        allowed-endpoints: >
          api.github.com:443
          github.com:443
          objects.githubusercontent.com:443
          pypi.org:443
          files.pythonhosted.org:443
          static.rust-lang.org:443
          crates.io:443
          index.crates.io:443
          fulcio.sigstore.dev:443
          rekor.sigstore.dev:443

    - name: Checkout
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

    - uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
    - uses: PyO3/maturin-action@b1bd829e37fef14c63f19162034228a2f3dc1021 # v1.50.0
      with:
        working-directory: ./jans-cedarling/bindings/cedarling_python
        command: build
        args: --release -i python3.11
        maturin-version: "1.9.4"

    - name: Sign and Upload Python
      env:
        GH_TOKEN: ${{ secrets.MOAUTO_WORKFLOW_TOKEN }}
        INPUT_TAG: ${{ github.event.inputs.target_tag }}
      run: |
        TAG_NAME=$([[ "${{ github.event_name }}" == "workflow_dispatch" ]] && echo "$INPUT_TAG" || echo "${{ github.event.ref }}" | cut -d '/' -f 3)
        cd jans-cedarling/target/wheels
        WHL=$(ls *.whl | head -n 1)
        cosign sign-blob --yes --bundle "${WHL}.bundle" "$WHL"
        gh release upload "${TAG_NAME}" *.whl *.bundle --clobber

  build_cedarling_go:
    if: |
      github.repository == 'JanssenProject/jans' &&
      (github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.run_cedarling_go))
    runs-on: ${{ matrix.os }}
    permissions:
      id-token: write
      contents: write
    strategy:
      fail-fast: false
      matrix:
        name: [ubuntu22, ubuntu22-arm, mac, windows]
        include:
          - name: ubuntu22
            os: ubuntu-22.04
          - name: ubuntu22-arm
            os: ubuntu-22.04-arm
          - name: mac
            os: macos-15
          - name: windows
            os: windows-2025
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@a90bcbc6539c36a85cdfeb73f7e2f433735f215b # v2.15.0
        with:
          egress-policy: block
          allowed-endpoints: >
            api.github.com:443
            github.com:443
            objects.githubusercontent.com:443
            static.rust-lang.org:443
            crates.io:443
            index.crates.io:443
            proxy.golang.org:443
            sum.golang.org:443
            fulcio.sigstore.dev:443
            rekor.sigstore.dev:443

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0
      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
            go-version: '1.24'
      - uses: dtolnay/rust-toolchain@efa25f7f19611383d5b0ccf2d1c8914531636bf9 # stable

      - name: Build Go Artifacts
        working-directory: ./jans-cedarling/bindings/cedarling_go
        shell: bash
        run: |
          cargo build -r -p cedarling_go
          TAG_NAME=$([[ "${{ github.event_name }}" == "workflow_dispatch" ]] && echo "${{ inputs.target_tag }}" || echo "${{ github.event.ref }}" | cut -d '/' -f 3)
          TAG=$(echo "${TAG_NAME}" | sed 's/^v//')
          [[ "$TAG" == "nightly" ]] && TAG="0.0.0"
          
          # Cross-platform binary handling
          if [[ "${{ matrix.os }}" == "windows"* ]]; then
            cp ../../target/release/cedarling_go.dll cedarling_go-${TAG}.dll
            cp ../../target/release/cedarling_go.dll.lib cedarling_go-${TAG}.lib
          elif [[ "${{ matrix.os }}" == "macos"* ]]; then
            cp ../../target/release/libcedarling_go.dylib libcedarling_go-${TAG}.dylib
          else
            ARCH=$([[ "${{ matrix.name }}" == *"arm" ]] && echo "arm64" || echo "x86-64")
            cp ../../target/release/libcedarling_go.so libcedarling_go-${TAG}_${ARCH}.so
          fi

      - name: Sign and Upload Go
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.MOAUTO_WORKFLOW_TOKEN }}
        run: |
          TAG_NAME=$([[ "${{ github.event_name }}" == "workflow_dispatch" ]] && echo "${{ inputs.target_tag }}" || echo "${{ github.event.ref }}" | cut -d '/' -f 3)
          cd jans-cedarling/bindings/cedarling_go
          for f in libcedarling_go* cedarling_go*; do
            cosign sign-blob --yes --bundle "${f}.bundle" "$f"
            gh release upload "$TAG_NAME" "$f" "${f}.bundle" --clobber
          done

  build_cedarling_krakend:
    if: |
      github.repository == 'JanssenProject/jans' &&
      (github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.run_cedarling_krakend))
    needs: build_cedarling_go
    runs-on: ubuntu-22.04
    permissions:
      id-token: write
      contents: write
    strategy:
      matrix:
        krakend-builder-image: [ 'builder:2.9.0', 'builder:2.9.0-linux-generic' ]
    steps:
    - name: Harden Runner
      uses: step-security/harden-runner@a90bcbc6539c36a85cdfeb73f7e2f433735f215b # v2.15.0
      with:
        egress-policy: block
        allowed-endpoints: >
          api.github.com:443
          github.com:443
          objects.githubusercontent.com:443
          auth.docker.io:443
          registry-1.docker.io:443
          production.cloudflare.docker.com:443
          fulcio.sigstore.dev:443
          rekor.sigstore.dev:443

    - name: Checkout
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

    - name: Build KrakenD Plugin
      env:
        GH_TOKEN: ${{ secrets.MOAUTO_WORKFLOW_TOKEN }}
        INPUT_TAG: ${{ github.event.inputs.target_tag }}
      run: |
        TAG_NAME=$([[ "${{ github.event_name }}" == "workflow_dispatch" ]] && echo "$INPUT_TAG" || echo "${{ github.event.ref }}" | cut -d '/' -f 3)
        TAG=$(echo "${TAG_NAME}" | sed 's/^v//')
        [[ "$TAG" == "nightly" ]] && TAG="0.0.0"
        
        cd jans-cedarling/cedarling-krakend
        # Download dependencies from previous jobs safely
        gh release download "$TAG_NAME" -p "libcedarling_go-${TAG}_x86-64.so" -O libcedarling_go.so
        
        IMAGE_NAME_CLEAN=$(echo "${{ matrix.krakend-builder-image }}" | tr ':' '-')
        docker run --rm -v "$PWD:/app" -w /app krakend/"${{ matrix.krakend-builder-image }}" sh -c "go build -buildmode=plugin -o cedarling-krakend-amd64-${IMAGE_NAME_CLEAN}-${TAG}.so ."
        
        cosign sign-blob --yes --bundle plugin.bundle *.so
        gh release upload "$TAG_NAME" *.so *.bundle --clobber

  build_cedarling_uniffi:
    if: |
      github.repository == 'JanssenProject/jans' &&
      (github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.run_cedarling_uniffi))
    runs-on: ubuntu-22.04
    permissions:
      id-token: write
      contents: write
    steps:
    - name: Harden Runner
      uses: step-security/harden-runner@a90bcbc6539c36a85cdfeb73f7e2f433735f215b # v2.15.0
      with:
        egress-policy: block
        allowed-endpoints: >
          api.github.com:443
          github.com:443
          objects.githubusercontent.com:443
          static.rust-lang.org:443
          crates.io:443
          index.crates.io:443
          fulcio.sigstore.dev:443
          rekor.sigstore.dev:443

    - name: Checkout
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
    - uses: dtolnay/rust-toolchain@efa25f7f19611383d5b0ccf2d1c8914531636bf9 # stable

    - name: Build UniFFI
      env:
        GH_TOKEN: ${{ secrets.MOAUTO_WORKFLOW_TOKEN }}
        INPUT_TAG: ${{ github.event.inputs.target_tag }}
      run: |
        TAG_NAME=$([[ "${{ github.event_name }}" == "workflow_dispatch" ]] && echo "$INPUT_TAG" || echo "${{ github.event.ref }}" | cut -d '/' -f 3)
        TAG=$(echo "${TAG_NAME}" | sed 's/^v//')
        [[ "$TAG" == "nightly" ]] && TAG="0.0.0"
        
        cd jans-cedarling/bindings/cedarling_uniffi
        cargo build -r -p cedarling_uniffi
        
        # Binary
        FILE="libcedarling_uniffi-${TAG}.so"
        cp ../../target/release/libcedarling_uniffi.so "$FILE"
        cosign sign-blob --yes --bundle "${FILE}.bundle" "$FILE"
        
        # Kotlin Bindings
        cargo run --bin uniffi-bindgen generate --library ../../target/release/libcedarling_uniffi.so --language kotlin --out-dir ./
        zip -r "cedarling_uniffi-kotlin-${TAG}.zip" uniffi
        
        gh release upload "$TAG_NAME" "$FILE" "$FILE.bundle" "cedarling_uniffi-kotlin-${TAG}.zip" --clobber