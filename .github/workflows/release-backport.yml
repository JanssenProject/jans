name: Backport
on:
  pull_request_target:
    types: [closed, labeled]
    branches: [main, 'release-*']

permissions:
  contents: read

jobs:
  backport:
    permissions:
      contents: write      # Required to push the backport branch
      pull-requests: write # Required to create the backport PR
    name: Backport Pull Request
    if: >
      github.repository == 'JanssenProject/jans'
      && github.event.pull_request.merged
      && (
        github.event.action == 'closed'
        || (
          github.event.action == 'labeled'
          && startsWith(github.event.label.name, 'backport/')
        )
      )
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@a90bcbc6539c36a85cdfeb73f7e2f433735f215b # v2.15.0
        with:
          egress-policy: block
          allowed-endpoints: >
            github.com:443
            api.github.com:443

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          token: ${{ secrets.MOAUTO_WORKFLOW_TOKEN }}

      - name: Create backport PRs
        uses: korthout/backport-action@01619ebc9a6e3f6820274221b9956b3e7365000a # v4.1.0
        with:
          github_token: ${{ secrets.MOAUTO_WORKFLOW_TOKEN }}
          label_pattern: ^backport\/([^ ]+)$
          pull_description: |-
            Automated backport to `${target_branch}`, triggered by a label in #${pull_number}.
            
            Original PR: #${pull_number}
            See ${issue_refs}.