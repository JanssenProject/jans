name: documentation
on:
  workflow_dispatch:
  pull_request:
    types:
      - opened
      - edited

permissions:
  contents: read
  pull-requests: read

jobs:
  check_pr_for_docs:
    if: github.repository == 'JanssenProject/jans' && startsWith(github.head_ref, 'dependabot/') != true
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Check commit message
        continue-on-error: false
        id: check_message
        run: |
          PULL_NUMBER=${{ github.event.pull_request.number }}
          echo "Parsing commits from PR $PULL_NUMBER"
          MESSAGE=$(gh pr view "$PULL_NUMBER" --json commits | jq -r '.commits[].messageHeadline' | grep "^docs" || echo "")
          echo "$MESSAGE"
          if [[ -z "$MESSAGE" ]]; then
            echo "conventional commit starting with docs: does not exist. Checking if user confirmed no impact on docs in PR body"
            pr_body=$(gh pr view https://github.com/${{ github.repository }}/pull/"$PULL_NUMBER" --json body -q '.body')
            if [[ $pr_body == *"- [x] **I confirm that there is no impact on the docs due to the code changes in this PR.**"* ]]; then
              echo "Checklist item is filled in PR body. Author confirmed no impact."
              exit 0
            else
              echo "Author did not check the item that states: **I confirm that there is no impact on the docs due to the code changes in this PR.**"
              exit 1
            fi            
          fi
          exit 0

  detect_docs_changes:
    if: github.repository == 'JanssenProject/jans' && github.event_name == 'pull_request'
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    runs-on: ubuntu-latest
    outputs:
      docs_changed: ${{ steps.check.outputs.docs_changed }}
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Check if docs changed
        id: check
        run: |
          PULL_NUMBER=${{ github.event.pull_request.number }}
          DOCS_FILES=$(gh pr view "$PULL_NUMBER" --repo "${{ github.repository }}" --json files --jq '.files.[].path' | grep '^docs/' || echo "")
          if [[ -n "$DOCS_FILES" ]]; then
            echo "docs_changed=true" >> $GITHUB_OUTPUT
          else
            echo "docs_changed=false" >> $GITHUB_OUTPUT
          fi

  docs:
    needs: detect_docs_changes
    if: needs.detect_docs_changes.outputs.docs_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Auto-merge inhouse doc prs
        run: |
          echo "${{ secrets.MOAUTO_WORKFLOW_TOKEN }}" | gh auth login --with-token
          PULL_NUMBER=${{ github.event.pull_request.number }}
          NUMBER_OF_FOLDERS_CHANGED=$(gh pr view $PULL_NUMBER --json files --jq '.files.[].path' | cut -d/ -f1 | sort -u | wc -l)
          echo "The number of folders that changed are $NUMBER_OF_FOLDERS_CHANGED"
          IS_USER_ORG_MEMBER=$(gh api -H "Accept: application/vnd.github.v3+json" --hostname github.com /orgs/${{ github.repository_owner }}/members?per_page=100 | jq .[].login | grep ${{ github.actor }})
          echo "checking if ${{ github.actor }} belongs to the ${{ github.repository_owner }}. Found $IS_USER_ORG_MEMBER."
          if [[ $NUMBER_OF_FOLDERS_CHANGED == "1" ]] && [[ ! -z "$IS_USER_ORG_MEMBER" ]]; then
            echo "Approving PR $PULL_NUMBER"
            gh pr review --approve $PULL_NUMBER
            echo "Merging PR $PULL_NUMBER"
            gh pr merge --squash --auto $PULL_NUMBER
          else
            echo "Bot will not merge this as it does not meet the requirements."
            echo "Either the developer has merged with doc changes code changes or an external contributor has requested doc changes."
          fi

  lint_docs:
    needs: detect_docs_changes
    if: needs.detect_docs_changes.outputs.docs_changed == 'true'
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Markdown linter
        continue-on-error: true
        run: |
          sudo apt-get install rubygems -y
          sudo gem install mdl
          mdl --style automation/markdown/.mdl_style.rb docs/
