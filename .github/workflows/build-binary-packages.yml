name: Build Binary Packages

on:
  push:
    tags:
    - '*'

  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        name: [ubuntu20, el8, suse15]

        include:
          - name: ubuntu20
            asset_suffix: ~ubuntu20.04_amd64.deb
            build_files: deb/focal      
            asset_prefix: '_'
            asset_path: jans
          - name: el8
            asset_suffix: .el8.x86_64.rpm
            build_files: rpm/el8       
            asset_prefix: '-'
            asset_path: jans/rpmbuild/RPMS/x86_64
          - name: suse15
            asset_suffix: .suse15.x86_64.rpm
            build_files: rpm/suse15
            asset_prefix: '-'
            asset_path: jans/rpmbuild/RPMS/x86_64

    steps:
    - name: Getting build dependencies
      run: |      
         git clone -b jans https://github.com/GluuFederation/packaging
         mkdir -p jans/jans-src/opt/
         cp -rp packaging/${{ matrix.build_files }}/* jans/
         wget https://raw.githubusercontent.com/JanssenProject/jans/main/jans-linux-setup/jans_setup/install.py -O jans/install.py
         sudo apt install -y python3-distutils python3-ldap3 build-essential devscripts debhelper rpm dpkg-sig
    - name: Configure GPG Key
      run: |
        echo -n "$GPG_SIGNING_KEY" | base64 --decode | gpg --import
      env:
        GPG_SIGNING_KEY: ${{ secrets.GPG_SIGNING_KEY }}         
    - name: Running install and build
      run: |
         cd jans/
         sudo python3.8 install.py --no-setup
         cp -r /opt/dist jans-src/opt/
         cp -r /opt/jans jans-src/opt/
         touch jans-src/opt/jans/jans-setup/package
         rm -rf install.py install jans-cli
         sed -i "s/%VERSION%/${GITHUB_REF##*/}/g" run-build.sh
         cat run-build.sh
         sudo ./run-build.sh
    - name: Upload binaries to release
      uses: svenstaro/upload-release-action@v2
      with:
        repo_token: ${{ secrets.MOWORKFLOWTOKEN }}
        file: ${{github.workspace}}/${{ matrix.asset_path }}/jans${{ matrix.asset_prefix }}${{ github.ref_name }}${{ matrix.asset_suffix }}
        asset_name: jans${{ matrix.asset_prefix }}${{ github.ref_name }}${{ matrix.asset_suffix }}
        tag: ${{ github.ref }} 
    - name: Upload checksum to release
      uses: svenstaro/upload-release-action@v2
      with:
        repo_token: ${{ secrets.MOWORKFLOWTOKEN }}
        file: ${{github.workspace}}/${{ matrix.asset_path }}/jans${{ matrix.asset_prefix }}${{ github.ref_name }}${{ matrix.asset_suffix }}.sha256sum
        asset_name: jans${{ matrix.asset_prefix }}${{ github.ref_name }}${{ matrix.asset_suffix }}.sha256sum
        tag: ${{ github.ref }}        
