name: sync
on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - "terraform-provider-jans/**"

concurrency:
  group: terraform-sync
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  publish:
    name: Push to terraform-provider-jans repo
    if: github.repository == 'JanssenProject/jans'
    runs-on: ubuntu-latest
    steps:
    - name: Harden Runner
      uses: step-security/harden-runner@a90bcbc6539c36a85cdfeb73f7e2f433735f215b # v2.15.0
      with:
        egress-policy: block
        allowed-endpoints: >
          github.com:443
          api.github.com:443

    - name: Checkout code
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      with:
        fetch-depth: 0
        token: ${{ secrets.MOAUTO_WORKFLOW_TOKEN }}

    - name: Split and sync to downstream repo
      env:
        GH_TOKEN: ${{ secrets.MOAUTO_WORKFLOW_TOKEN }}
      run: |
        # Configure Git Identity
        git config --global user.name "mo-auto"
        git config --global user.email "54212639+mo-auto@users.noreply.github.com"

        # Use GH CLI to safely handle git authentication
        gh auth setup-git

        SPLIT_BRANCH="terraform-split"
        echo "Performing subtree split..."
        git subtree split --prefix=terraform-provider-jans -b "$SPLIT_BRANCH"

        DOWNSTREAM="https://github.com/JanssenProject/terraform-provider-jans.git"
        git remote add downstream "$DOWNSTREAM"
        
        # Fetching without tags to keep the downstream lean
        git fetch --no-tags downstream

        echo "Pushing split branch to downstream main..."
        # --force-with-lease is safer than --force as it prevents overwriting 
        # work it hasn't seen yet.
        git push downstream "${SPLIT_BRANCH}:main" --force-with-lease