name: Generate and Upload SBOM Reports

on:
  push:
    tags:
      - 'v**'
      - 'nightly'

permissions:
  contents: read

jobs:
  enrich_and_upload_sbom:
    permissions:
      contents: write  # to upload SBOM and compliance reports to release
      id-token: write  # for Cosign keyless OIDC signing
    if: github.repository == 'JanssenProject/jans'
    runs-on: ubuntu-latest
    steps:
    - name: Harden Runner
      uses: step-security/harden-runner@a90bcbc6539c36a85cdfeb73f7e2f433735f215b # v2.15.0
      with:
        egress-policy: block
        allowed-endpoints: >
          api.github.com:443
          github.com:443
          objects.githubusercontent.com:443
          fulcio.sigstore.dev:443
          rekor.sigstore.dev:443
          tuf-repo-cdn.sigstore.dev:443
          sigstore-tuf-root.storage.googleapis.com:443
          api.deps.dev:443
          api.securityscorecards.dev:443

    - name: Install Cosign
      uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0

    - name: Fetch Jans SBOM from Github
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Added GH_TOKEN to avoid rate limits and 403s
        gh api -H "Accept: application/vnd.github.v3.raw" \
           /repos/JanssenProject/jans/dependency-graph/sbom \
           > gh-sbom.json
        
        jq '.sbom' gh-sbom.json > trimmed-sbom.json

    - name: Install Parlay
      run: |
        # Optimized download: targets a specific version for stability
        PARLAY_VER="0.6.0" 
        curl -LO "https://github.com/snyk/parlay/releases/download/v${PARLAY_VER}/parlay_linux_amd64"
        chmod +x parlay_linux_amd64
        sudo mv parlay_linux_amd64 /usr/local/bin/parlay

    - name: Enrich SBOM using Parlay
      run: |
        parlay ecosystems enrich trimmed-sbom.json > jans-sbom-ecosystem.json
        parlay scorecard enrich jans-sbom-ecosystem.json > jans-sbom.json

    - name: Install sbomqs
      run: |
        QS_VER="0.0.33"
        curl -LO "https://github.com/interlynk-io/sbomqs/releases/download/v${QS_VER}/sbomqs_linux_amd64"
        chmod +x sbomqs_linux_amd64
        sudo mv sbomqs_linux_amd64 /usr/local/bin/sbomqs

    - name: Generate compliance reports
      run: |        
        sbomqs compliance --fsct -j jans-sbom.json > jans-sbom-fsct-report.json
        sbomqs compliance --bsi-v2 -j jans-sbom.json > jans-sbom-bsi-v2-report.json
        sbomqs compliance --ntia -j jans-sbom.json > jans-sbom-NTIA-report.json
        sbomqs compliance --oct -j jans-sbom.json > jans-sbom-openchain-report.json

    - name: Sign Artifacts
      run: |
        for file in jans-sbom.json jans-sbom-fsct-report.json jans-sbom-bsi-v2-report.json jans-sbom-NTIA-report.json jans-sbom-openchain-report.json; do
          cosign sign-blob --yes --bundle "${file}.bundle" "${file}"
        done

    - name: Upload to Release
      env:
        GH_TOKEN: ${{ secrets.MOAUTO_WORKFLOW_TOKEN }}
        VERSION: ${{ github.ref_name }}
      run: |
        gh release upload "$VERSION" \
          jans-sbom.json jans-sbom.json.bundle \
          jans-sbom-fsct-report.json jans-sbom-fsct-report.json.bundle \
          jans-sbom-bsi-v2-report.json jans-sbom-bsi-v2-report.json.bundle \
          jans-sbom-NTIA-report.json jans-sbom-NTIA-report.json.bundle \
          jans-sbom-openchain-report.json jans-sbom-openchain-report.json.bundle \
          --clobber