name: Publish docs via GitHub Pages

on:
  push:
    branches:
      - main
    paths:
      - 'docs/**'
      - 'charts/**'
      - 'mkdocs.yml'
      - 'docker-jans-**/README.md'
      - 'CHANGELOG.md'
  pull_request:
    branches:
      - main
    paths:
      - 'docs/**'
      - 'charts/**'
      - 'mkdocs.yml'
      - 'docker-jans-**/README.md'
      - 'CHANGELOG.md'
  release:
    types:
      - published
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g."v1.6.0")'
        default: "nightly"
        required: false

concurrency:
  group: run-once
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  build:
    permissions:
      contents: write  # Required for Git push to gh-pages
      pull-requests: write # Required for generating auto-docs PR
    if: github.repository == 'JanssenProject/jans'
    name: Deploy docs
    runs-on: ubuntu-latest

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@a90bcbc6539c36a85cdfeb73f7e2f433735f215b # v2.15.0
        with:
          egress-policy: block
          allowed-endpoints: >
            api.github.com:443
            github.com:443
            objects.githubusercontent.com:443
            pypi.org:443
            files.pythonhosted.org:443
            install.python-poetry.org:443
            get.helm.sh:443
            keys.openpgp.org:443
            keyserver.ubuntu.com:11371
            azure.archive.ubuntu.com:80
            esm.ubuntu.com:443
            motd.ubuntu.com:443

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0
          token: ${{ secrets.MOAUTO_WORKFLOW_TOKEN }}

      - name: Set up JDK 17
        uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5.2.0
        with:
          java-version: '17'
          distribution: 'adopt'
          cache: maven

      - name: Set up Python 3.10
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version: "3.10"
          cache: pip

      - name: Install dependencies
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          export PATH="$HOME/.local/bin:$PATH"
          if [ -f docs/pyproject.toml ]; then
            cp docs/pyproject.toml docs/poetry.lock ../ || true
          fi
          poetry install --no-root
          cp mkdocs.yml CHANGELOG.md ../ || true

      - name: Checkout target version (Dispatch Only)
        if: github.event_name == 'workflow_dispatch'
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ github.event.inputs.version }}
          fetch-depth: 0
          token: ${{ secrets.MOAUTO_WORKFLOW_TOKEN }}

      - name: Copy files from main to target
        if: github.event_name == 'workflow_dispatch'
        run: |
          mv ../mkdocs.yml mkdocs.yml || true
          cp ../CHANGELOG.md docs/CHANGELOG.md || true

      - name: Sync CHANGELOG to docs
        if: github.event_name != 'workflow_dispatch'
        run: cp CHANGELOG.md docs/CHANGELOG.md || true

      - name: Copy generated chart
        run: |
          helm package charts/janssen/
          helm package charts/janssen-all-in-one/
          cp janssen-*.tgz ../

      - name: Import GPG key
        id: import_gpg
        uses: crazy-max/ghaction-import-gpg@01dd5d3ca463c7f10f7f4f7b4f177225ac661ee4 # v6.1.0
        with:
          gpg_private_key: ${{ secrets.MOAUTO_GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.MOAUTO_GPG_PRIVATE_KEY_PASSPHRASE }}
          git_user_signingkey: true
          git_commit_gpgsign: true

      - name: Configure Git & Auth
        env:
          GH_TOKEN: ${{ secrets.MOAUTO_WORKFLOW_TOKEN }}
        run: |
          git config --global user.name "mo-auto"
          git config --global user.email "54212639+mo-auto@users.noreply.github.com"
          git config --global user.signingkey "${{ steps.import_gpg.outputs.keyid }}"
          gh auth setup-git

      - name: Generate auto-docs
        continue-on-error: true
        if: >-
          github.event_name == 'release' &&
          github.event.action == 'published' &&
          (!github.event.release.draft) &&
          (startsWith(github.event.release.name, 'v') || github.event.release.name == 'nightly')
        env:
          GH_TOKEN: ${{ secrets.MOAUTO_WORKFLOW_TOKEN }}
        run: |
          mkdir -p temp && cd temp
          gh repo clone JanssenProject/jans .
          git checkout -b cn-jans-update-auto-generated-docs
          git pull origin cn-jans-update-auto-generated-docs || echo "Branch is new"

          echo "Generating docs..."
          sudo bash ./automation/docs/generate-autogenerated-docs.sh . || echo "Prop docs failed"
          git add .
          git commit -S -m "docs: auto-generated property docs" || echo "No changes"

          sudo bash ./automation/docs/generate-swagger-specs.sh . || echo "Swagger failed"
          git add .
          git commit -S -m "docs: auto-generated Swagger SPEC docs" || echo "No changes"

          git push origin cn-jans-update-auto-generated-docs
          gh pr create --body "Auto generated docs" --title "fix(docs): autogenerate docs" || echo "PR exists"
          cd ../ && sudo rm -rf temp

      - name: Deploy with Mike
        env:
          GH_TOKEN: ${{ secrets.MOAUTO_WORKFLOW_TOKEN }}
          INPUT_VERSION: ${{ github.event.inputs.version }}
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          
          # Use latest template overrides
          if [[ "${{ github.event_name }}" == "workflow_dispatch" || "${{ github.event_name }}" == "release" ]]; then
            git show origin/main:docs/overrides/main.html > docs/overrides/main.html || true
          fi

          # Enable tracking flags for versions
          if [[ "${{ github.event_name }}" == "workflow_dispatch" || "${{ github.event_name }}" == "release" ]]; then
            sed -i 's/enable_scarf_pixel: false/enable_scarf_pixel: true/' mkdocs.yml
            sed -i 's/enable_reo_flag: false/enable_reo_flag: true/' mkdocs.yml
          fi

          # Deploy logic
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            poetry run mike deploy --push --update-aliases "$INPUT_VERSION"
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            poetry run mike deploy --push head
          elif [[ "${{ github.event_name }}" == "release" ]]; then
            poetry run mike deploy --push "${{ github.event.release.tag_name }}"
          fi

      - name: Update Aliases & gh-pages
        id: set_versions
        env:
          GH_TOKEN: ${{ secrets.MOAUTO_WORKFLOW_TOKEN }}
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          TAGS=$(gh release list -L 1000 | grep -o '^\v.*'| grep -v Draft | cut -f 1 | sed '/-/!{s/$/_/}' | sort -V | sed 's/_$//')
          STABLE=$(echo "${TAGS}" | grep -v -- "nightly" | tail -1)
          LATEST=$( [[ "${{ github.event.release.tag_name }}" == "nightly" ]] && echo "nightly" || echo "${TAGS}" | tail -1 )
          
          poetry run mike alias -u head main
          poetry run mike alias -u "${STABLE}" stable
          poetry run mike set-default --push stable
          
          echo "LATEST=$LATEST" >> $GITHUB_OUTPUT
          echo "STABLE=$STABLE" >> $GITHUB_OUTPUT

      - name: Post-process gh-pages
        env:
          LATEST: ${{ steps.set_versions.outputs.LATEST }}
          STABLE: ${{ steps.set_versions.outputs.STABLE }}
        run: |
          git checkout -f gh-pages
          git pull origin gh-pages
          
          # Manage Helm Charts
          mkdir -p charts
          mv ../janssen-*.tgz ./charts/
          cd charts && helm repo index . && cd ..
          
          # Versioned search and string replacement
          for folder in v*/; do
            cp -r nightly/search "$folder" || true
          done
          
          if [ -d "$LATEST" ]; then
            cd "$LATEST"
            VERSION_STR=$([[ "$LATEST" == "nightly" ] ] && echo "0.0.0-nightly" || echo "${LATEST:1}")
            find . -type f -not -name "CONTRIBUTING.md" -print0 | xargs -0 sed -i "s/replace-janssen-version-stable/$VERSION_STR/g"
            find . -type f -not -name "CONTRIBUTING.md" -print0 | xargs -0 sed -i "s/replace-janssen-version/$VERSION_STR/g"
            cd ..
          fi
          
          # Final Commit
          echo "$STABLE" > stable.txt
          echo "$LATEST" > latest.txt
          git add .
          git diff-index --quiet HEAD -- || git commit -S -m "docs: finalize versioning and charts"
          git push origin gh-pages