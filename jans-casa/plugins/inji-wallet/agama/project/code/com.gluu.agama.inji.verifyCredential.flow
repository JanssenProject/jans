Flow com.gluu.agama.inji.verifyCredential
     Basepath ""
     Configs conf
// Flow Starting
Log "@info Start executing Agama-Inji wallet flow"
// Feedback message
feedback = {}
// Max repeate
Repeat 3 times max
     // Create an instance of Agma-inji verification Service
     agamaInjiVerificationService = Call org.gluu.agama.inji.AgamaInjiVerificationService#getInstance conf
     // Send an Authorization Request to Inji verify endpoint
     verificationResult = Call agamaInjiVerificationService createVpVerificationRequest 
     // Check verification result.
     When verificationResult.valid is true
          // The service has been verified
          Log "@info The service has been verified"
          // Construct OpenID4VP Request url for RFAC call
          rfacUrl = Call agamaInjiVerificationService buildInjiWebAuthorizationUrl verificationResult.requestId verificationResult.transactionId
          // Making RFAC call
          Log "@info Making RFAC call to Inji web  app. URL is : %"  rfacUrl
          // Inji web app response
          resultFromApp = RFAC rfacUrl
          // Verify apps returned result
          Log "@info Verify external app return result"
          // verify final result
          verifyFinalStatus = Call agamaInjiVerificationService verifyInjiAppResult verificationResult.requestId verificationResult.transactionId
          // Checking final status
          When verifyFinalStatus.valid is true
               // Final verification done
               Log "@info Final verification successfully done"
               // Extract user info from VC (NID)
               vcUserInfo = Call agamaInjiVerificationService extractUserInfoFromVC 
               // Check if user info extracted
               When vcUserInfo is not null
                    // User info extracted from VC
                    Log "@info User info extracted from VC"
                    // Check if user already exists
                    existingUser = Call agamaInjiVerificationService checkUserExists vcUserInfo.mail
                    When existingUser is not null
                         // User already registered, log them in
                         Log "@info User already registered, logging in"
                         // Acknowledge
                         ack = RRF "acknowledge.ftlh" 
                         // Flow finish successfully
                         it_uwjdw = {success:true, data: { userId: existingUser.uid, mail: existingUser.mail, displayName: existingUser.displayName, givenName: existingUser.givenName}}
                         Finish it_uwjdw
                    Otherwise
                         // showing form
                         Log "@info Showing user registration form with data : %" vcUserInfo
                         // Show user setup page to review info and set password
                         userSetupData = RRF "usersetup.ftlh" vcUserInfo
                         // Check if password provided
                         When userSetupData.password is not null
                              Log "@info Creating user with provided data and password"
                              // OnBoard User to Jans Server with all data including password
                              user = Call agamaInjiVerificationService onboardUser userSetupData userSetupData.password
                              // If user is not null
                              When user is not null
                                   // user onboard success
                                   Log "@info User onboard success with password"
                                   // Acknowledge
                                   ack = RRF "acknowledge.ftlh" 
                                   // Flow finish successfully
                                   it_zpqek = {success:true, data: { userId: user.uid, mail: user.mail, displayName: user.displayName, givenName: user.givenName}}
                                   Finish it_zpqek
                              Otherwise
                                   // Failed to onboard user
                                   Log "@error Failed to onboard use"
                                   feedback.errorMessage = "Failed to create user account"
                                   // show error
                                   RRF "error.ftlh" feedback
                         Otherwise
                              // Password not provided
                              Log "@error Password not provided"
                              feedback.errorMessage = "Password is required"
                              // show error
                              RRF "error.ftlh" feedback
               Otherwise
                    // Failed to extract user info
                    Log "@info Failed to extract user info from VC"
                    // Failed to onbaord user
                    feedback.errorMessage = "Failed to extract user information from credential"
                    // show error
                    RRF "error.ftlh" feedback
          Otherwise
               // Validation faild
               Log "@info Validation failed"
               // Errror message
               feedback.errorMessage = verifyFinalStatus.message
               // Showing error
               RRF "error.ftlh" feedback
     Otherwise
          // The service has been not verified
          Log "@error The service has been not verified"
          // Error message
          feedback.errorMessage = verificationResult.message
          // Showing error
          RRF "error.ftlh" feedback
// Max tries 
Log "@info You've reached the max tries"
// Finish with error
it_hksvg = {success:false, error: "You've reached max tries."}
Finish it_hksvg