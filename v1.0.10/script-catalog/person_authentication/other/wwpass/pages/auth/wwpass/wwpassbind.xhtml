  <!DOCTYPE composition
      PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
  <ui:composition xmlns="http://www.w3.org/1999/xhtml" xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets" xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:b="http://bootsfaces.net/ui"
      template="/WEB-INF/incl/layout/template.xhtml">
      <f:metadata>
        <f:viewAction action="#{authenticator.prepareAuthenticationForStep}"/>

        <f:viewParam name="login_hint" value="#{loginAction.loginHint}" />
      </f:metadata>

      <ui:define name="head">
          <meta name="viewport" content="width=device-width, initial-scale=1" />
          <meta name="description" content="WWPass Bind page description" />
          <style>
.body {
  font-family: "Roboto", "Arial", sans-serif;
  color: #707070;
  font-weight: 300;
  background: #EEF2FA;
  background-repeat: no-repeat;
  background-position: center;
  background-size: cover;
  min-width: 320px;
  min-height: 100vh;
  display: -webkit-box;
  display: -ms-flexbox;
  display: flex;
  -webkit-box-orient: vertical;
  -webkit-box-direction: normal;
      -ms-flex-direction: column;
          flex-direction: column;
  -webkit-box-pack: justify;
      -ms-flex-pack: justify;
          justify-content: space-between;
  margin: 0;
  padding: 0 !important;
  width: auto !important; }

.content {
  width: 100%;
  max-width: 290px;
  margin: auto;
  display: -webkit-box;
  display: -ms-flexbox;
  display: flex;
  -webkit-box-orient: vertical;
  -webkit-box-direction: normal;
      -ms-flex-direction: column;
          flex-direction: column; }

.content--center {
  text-align: center; }

.content--narrow {
  max-width: 290px; }

.content__element {
  width: 100%;
  max-width: 690px;
  background-color: #ffffff;
  border: 1px solid #dddddd;
  border-radius: 15px;
  -webkit-margin-before: 10px;
          margin-block-start: 10px;
  -webkit-padding-after: 15px;
          padding-block-end: 15px; }

.content__element--first {
  -webkit-box-ordinal-group: 0;
      -ms-flex-order: -1;
          order: -1; }

#status {
  display: none; }

.button {
  display: flex;
  min-width: 200px;
  height: 40px;
  margin: 0 auto;
  font-size: 14px;
  line-height: 34px;
  font-weight: 400;
  text-decoration: none;
  text-align: center;
  border-radius: 4px;
  -webkit-padding-start: 15px;
          padding-inline-start: 15px;
  -webkit-padding-end: 15px;
          padding-inline-end: 15px;
  display: inline-block;
  -webkit-margin-before: 20px;
          margin-block-start: 20px;
  -webkit-margin-after: 30px;
          margin-block-end: 30px;
  cursor: pointer;
  -webkit-box-sizing: border-box;
          box-sizing: border-box; }

.form__label {
  display: -webkit-box;
  display: -ms-flexbox;
  display: flex;
  -webkit-box-orient: vertical;
  -webkit-box-direction: normal;
      -ms-flex-direction: column;
          flex-direction: column;
  -webkit-margin-before: 5px;
          margin-block-start: 5px;
  font-size: 13px;
  line-height: 18px; }
.qrcode--tap {
  position: relative; }

.qrcode--tap::before {
  position: absolute;
  display: block;
  content: '';
  width: 100%;
  height: 100%;
  top: 0;
  left: 0;
  z-index: 5;
  background-color: rgba(0, 0, 0, 0.65);
  /* <![CDATA[ */
  background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="Layer_1" x="0px" y="0px" viewBox="0 0 177 177" style="enable-background:new 0 0 177 177;" xml:space="preserve"><style type="text/css">.st0{fill:none;stroke:%23FFFFFF;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:10;}%3C%2Fstyle%3E<g><line class="st0" x1="80" y1="46.5" x2="80" y2="40"/><line class="st0" x1="70.8" y1="50.3" x2="66.2" y2="45.7"/><line class="st0" x1="89.2" y1="50.3" x2="93.8" y2="45.7"/><line class="st0" x1="93" y1="59.6" x2="99.6" y2="59.6"/><line class="st0" x1="60.4" y1="59.6" x2="67" y2="59.6"/></g><g>	<path class="st0" d="M123.9,134.3l-4.9,13c-0.5,1.6-0.9,4.2-0.9,5.8v6.9H77v-7.6c0-1.8-0.3-3.6-1.6-4.8l-7.2-6.6   c-2.1-2.1-3.8-4.6-4.9-7.3l-2.2-4.9c-1.3-3-3.6-5.6-6.4-7.3l-5.3-3.6c-2.2-1.5-3.3-3.5-3.3-6.4c0-3.2,2.6-6.5,6.5-6.5   c1.4,0,2.9,0.3,4.1,0.8l0,0c4.8,2,9.2,5,12.9,8.8l3.6,4.5v-15.7V59.9c0-3.4,3.3-6.8,7-6.8c3.8,0,7,3.1,7,7.3v23.5   c1.3-1.6,3.8-2.6,6.1-2.6c3.9,0,7.1,3.2,7.1,7.1l0.1,1.4c1.2-2.2,3.5-3.6,6.2-3.6c3.6,0,6.6,2.8,7,6.3c0,0,0,0,0,0   c0.9-0.4,1.9-0.6,2.9-0.6c3.4,0,6.3,2.5,6.9,5.7c0,0,2.7,17.7,2.7,23.5C126,128.1,125.2,130.4,123.9,134.3z"/><line class="st0" x1="87.3" y1="103.3" x2="87" y2="83.9"/><line class="st0" x1="100.7" y1="103.8" x2="100.2" y2="89.7"/><line class="st0" x1="114.1" y1="107" x2="113.4" y2="92.4"/><line class="st0" x1="113.4" y1="92.4" x2="113.4" y2="92.4"/></g></svg>');
  /* ]]> */
  -webkit-animation-name: qrtapAnimation;
          animation-name: qrtapAnimation;
  -webkit-animation-timing-function: ease;
          animation-timing-function: ease;
  -webkit-animation-iteration-count: infinite;
          animation-iteration-count: infinite;
  -webkit-animation-duration: 2.5s;
          animation-duration: 2.5s;
  -webkit-animation-direction: alternate;
          animation-direction: alternate;
  pointer-events: none; }

@-webkit-keyframes qrtapAnimation {
  0%,
  55% {
    opacity: 0;
    background-color: rgba(0, 0, 0, 0); }
  80%,
  to {
    opacity: 1;
    background-color: rgba(0, 0, 0, 0.6); } }

@keyframes qrtapAnimation {
  0%,
  55% {
    opacity: 0;
    background-color: rgba(0, 0, 0, 0); }
  80%,
  to {
    opacity: 1;
    background-color: rgba(0, 0, 0, 0.6); } }
.text {
  font-size: 15px;
  line-height: 22px;
  max-width: 910px;
  -webkit-margin-start: 10px;
          margin-inline-start: 10px;
  -webkit-margin-end: 10px;
          margin-inline-end: 10px; }
          </style>
        </ui:define>

      <ui:define name="pageTitle">
          <h:outputText value="#{msgs['login.pageTitle']}" />
      </ui:define>

      <ui:define name="body">
        <div class="content">
          <div class="content__element content__element--first content--center  content--narrow">
            <div id="errors" style="color:red;">
              <p>#{identity.getWorkingParameter('errors')}</p>
            </div>
            <h:panelGroup rendered="#{!(''.equals(identity.getWorkingParameter('allow_email_bind')))}">
              <div class="bind_option">
                <input type="submit" value="Bind with an email" class="button button--action button--bind"/>
              </div>

              <div id="email_bind" style="display: none;">
                <b:form id="bindEmailForm" name="bindEmailForm" method="post" class="form form--bind" enctype="application/x-www-form-urlencoded">
                  <input type="hidden" name="loginForm" value="bindEmailForm" />
                  <p class="text">Enter an email for your existing account</p>

                  <label for="email" class="form__label">
                    Email
                  </label>
                  <input placeholder="user@example.com" name="email"
                    required="true" value="" class="form__input">
                  </input>

                  <h:commandButton id="loginButton" styleClass="button button--action"
                        value="Verify email" action="#{authenticator.authenticate}" />
                </b:form>

              </div>
            </h:panelGroup>
            <h:panelGroup rendered="#{!(''.equals(identity.getWorkingParameter('allow_password_bind')))}">
              <div class="bind_option">
                <input type="submit" value="Bind with a password" class="button button--action button--bind"/>
              </div>

              <div id="password_bind" style="display: none;">
                <b:form id="loginForm" name="loginForm" method="post" class="form form--bind" enctype="application/x-www-form-urlencoded">
                  <input type="hidden" name="loginForm" value="loginForm" />
                  <p class="text">Enter your credentials to bind PassKey to your account</p>

                  <label for="loginForm:username" class="form__label"
                  value="#{msgs['login.username']}">
                    Username
                  </label>
                  <b:inputText placeholder="#{msgs['login.username']}" fieldId="loginForm:username" name="loginForm:username"
                    required="true" autocomplete="off" value="#{credentials.username}" class="form__input">
                  </b:inputText>

                  <label for="loginForm:password" class="form__label" value="#{msgs['login.password']}">Password</label>
                  <b:inputSecret placeholder="#{msgs['login.password']}"
                    fieldId="loginForm:password" name="loginForm:password" value="#{credentials.password}"
                    autocomplete="off" class="form__input">
                  </b:inputSecret>

                  <h:commandButton id="loginButton" styleClass="button button--action"
                        value="Bind" action="#{authenticator.authenticate}" />
                </b:form>

              </div>
            </h:panelGroup>

            <h:panelGroup rendered="#{!(''.equals(identity.getWorkingParameter('allow_passkey_bind')))}">
              <div class="bind_option">
                <input type="submit" value="Bind with another PassKey" class="button button--action button--bind"/>
              </div>

              <div id="bind" style="display: none;">
                <div class="" align="center">
                  <p class="text">Scan QRCode to bind the previous PassKey to your account</p>
                </div>
                <div class="" align="center">
                  <div id="qrcode" style="width: 196px; height: 196px;"></div>
                  <div id="passkey" style="display:none">
                    <button class="button button--action">Log in with PassKey</button>
                  </div>
                </div>
              </div>
            </h:panelGroup>

            <h:panelGroup rendered="#{!(''.equals(identity.getWorkingParameter('registration_url')))}">
              <div id="register" class="bind_option">
                <form id="registerForm" class=""
                  action="#{identity.getWorkingParameter('registration_url')}" method="post">
                  <div class="">
                    <div class="">
                      <h:commandButton id="registerUser" styleClass="button button--action" value="Register a new user" />
                    </div>
                  </div>
                  <h:inputHidden id="ticket" value="#{identity.getWorkingParameter('ticket')}" />
                  <h:inputHidden id="puid" value="#{identity.getWorkingParameter('puid')}" />
                </form>
              </div>
            </h:panelGroup>
            <h:panelGroup rendered="#{!(''.equals(identity.getWorkingParameter('recovery_url')))}" class="bind_option">
              <div id="recovery">
                <p class="text">You presented a new WWPass Key, not associated with any account. If you already have an account, and need to replace your WWPass Key, please follow <a href="#{identity.getWorkingParameter('recovery_url')}">this link</a>.</p>
              </div>
            </h:panelGroup>
          </div>
        </div>
        <script type="text/javascript"
        src="/oxauth/ext/resources/js/wwpass-frontend.js" />
        <script type="text/javascript">
          /* <![CDATA[ */
          window.onload = function () {
            var binds = document.querySelectorAll(`.bind_option`);
              if (binds) {
                for (i=0 ; i < binds.length ; i++) {
                  var bind = binds[i];
                  var buttons = bind.getElementsByClassName('button--bind');
                  if (buttons.length > 0) {
                    buttons[0].addEventListener(`click`, function(evt) {
                      evt.preventDefault();
                      evt.target.parentElement.nextElementSibling.style.display = null;
                      for (j=0 ; j < binds.length ; j++) {
                        var bind = binds[j];
                        bind.style.display = `none`;
                      }
                    });
                    buttons[0].removeAttribute("disabled");
                  }
                }
              }
              WWPass.authInit({
                  qrcode:'#qrcode',
                  passkey:'#passkey',
                  forcePasskeyButton: false,
                  callbackURL: window.location.protocol + '//' + window.location.hostname + '#{request.contextPath}/postlogin.htm',
                  ticketURL: "/wwpass/ticket.json?#{identity.getWorkingParameter('use_pin')?'p=1':''}"
              });
          };
        /* ]]> */
        </script>
        <script>
          /* <![CDATA[ */
          function isMobile() { return navigator && (
            ('userAgent' in navigator && navigator.userAgent.match(/iPhone|iPod|iPad|Android/i))
            || (navigator.maxTouchPoints > 1 && !navigator.userAgent.match(/Windows/i))
          ) && !window.MSStream;};

          if (isMobile()) {
            var qrcode = document.querySelector(`#qrcode`);
            qrcode.classList.add(`qrcode--tap`);
          }
          // 90% of session lifetime
          var timeout = 0#{identity.getWorkingParameter('sessionLifetime')} * 900;
          // Prevent session timeout while the tab is open
          setInterval(function(){fetch(window.location.href)}, timeout);
          /* ]]> */
        </script>

      </ui:define>

  </ui:composition>

