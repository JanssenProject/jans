#!/bin/bash
set -e
DATE=$(date +%F_%H-%M-%S)
SERVICE=$1
APP="janssen-$SERVICE"
BUILD=""
if [[ $SERVICE == "auth" ]];then
  APP="janssen-$SERVICE-server"
fi

POD_NAME=$(microk8s.kubectl get pods --selector=app="$APP" --output=jsonpath={.items[0]..metadata.name} -n jans)
IFS="=" read name BUILD <<< "$(microk8s.kubectl exec -ti "$POD_NAME" -n jans -- printenv | grep "CN_BUILD_DATE=")"
if [[ $SERVICE == "client-api" ]];then
  microk8s.kubectl cp -n jans "$POD_NAME":opt/client-api/logs/ jans-"$SERVICE"-logs && zip -r jans-"$SERVICE"-logs-"$DATE".zip jans-"$SERVICE"-logs && rm -rf jans-"$SERVICE"-logs/
else
  microk8s.kubectl cp -n jans "$POD_NAME":opt/jans/jetty/jans-"$SERVICE"/logs jans-"$SERVICE"-logs && zip -r jans-"$SERVICE"-logs-"$DATE".zip jans-"$SERVICE"-logs && rm -rf jans-"$SERVICE"-logs/
fi


curl "https://chat.gluu.org/api/v1/rooms.upload/bot_reporter" \
    -F "file=@jans-$SERVICE-logs-$DATE.zip" \
    -F "msg=$APP built on $BUILD ran into an issue. Here are the logs." \
    -F "description=These logs were autogenerated from an ephemeral environment" \
    -H "X-Auth-Token: $2" \
    -H "X-User-Id: $3"
