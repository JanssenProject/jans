FROM blazemeter/taurus:master-f96971fa-2022-12-12

# ===============
# Ubuntu packages
# ===============

RUN apt-get clean \
&& mv /var/lib/apt/lists /tmp \
&& mkdir -p /var/lib/apt/lists/partial \
&& apt-get clean

RUN apt-get update \
    &&  apt-get install openjdk-8-jre-headless wget git bash python3-dev lsb-core python3-setuptools cmake build-essential apt-utils python3-pip -y

# ===============
# Environmental Variables
# ===============

ENV FQDN="https://example.jans.io" \
    AUTHZ_CLIENT_ID="" \
    AUTHZ_CLIENT_SECRET="" \
    ROPC_CLIENT_ID="" \
    ROPC_CLIENT_SECRET="test_ro_client_password" \
    FIRST_BATCH_MIN=0 \
    FIRST_BATCH_MAX=5000000 \
    SECOND_BATCH_MIN=5000001\
    SECOND_BATCH_MAX=50000000 \
    RUN_AUTHZ_TEST=false \
    RUN_ROPC_TEST=false \
    TEST_USERS_PREFIX_STRING="test_user" \
    COUCHBASE_URL="" \
    COUCHBASE_PW="" \
    USER_NUMBER_STARTING_POINT=0 \
    USER_NUMBER_ENDING_POINT=50000000 \
    LOAD_USERS_TO_COUCHBASE="" \
    LOAD_USERS_TO_LDAP="" \
    LOAD_USERS_TO_SPANNER="" \
    LOAD_USERS_TO_RDBMS="" \
    GOOGLE_APPLICATION_CREDENTIALS=""\
    GOOGLE_PROJECT_ID=""\
    GOOGLE_SPANNER_INSTANCE_ID=""\
    GOOGLE_SPANNER_DATABASE_ID=""\
    LDAP_URL="" \
    LDAP_PW="" \
    LDAP_DN="" \
    # pgsql or mysql
    RDBMS_TYPE="" \
    RDBMS_DB="" \
    RDBMS_USER="" \
    RDBMS_PASSWORD="" \
    RDBMS_HOST=""

# ===============
# Install Couchbase Client
# ===============

RUN apt-get update \
    && python3 -m pip install couchbase

# =======================
# Install Spanner package
# =======================

RUN python3 -m pip install google-cloud-spanner

# ===============
# Packages
# ===============
RUN pip install joblib ldap3 pygtail psycopg2 PyMySQL

COPY scripts /scripts

RUN mkdir -p /root/.bzt/jmeter-taurus \
    && wget -q https://dlcdn.apache.org//jmeter/binaries/apache-jmeter-5.5.tgz -O /scripts/apache-jmeter-5.5.tgz \
    && tar zxvf /scripts/apache-jmeter-5.5.tgz -C /root/.bzt/jmeter-taurus \
    && mv /root/.bzt/jmeter-taurus/apache-jmeter-5.5 /root/.bzt/jmeter-taurus/5.5

ENTRYPOINT ["bash", "/scripts/entrypoint.sh"]
